<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abai Springs Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            text-decoration: none;
            color: #666;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem;
            overflow-y: auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
        }
        
        .stat-subtitle {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.2rem;
            opacity: 0.8;
        }
        
        /* Content Sections */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h2 i {
            color: #667eea;
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        /* Product status styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.active {
            background: #28a745;
            color: white;
        }
        
        .status-badge.inactive {
            background: #6c757d;
            color: white;
        }
        
        .inactive-product {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        
        .inactive-product td {
            color: #6c757d;
        }

        /* Outlet Inventory Styling */
        .outlet-inventory-header {
            margin-bottom: 20px;
        }

        .outlet-inventory-header h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .outlet-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .outlet-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .outlet-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            pointer-events: none;
        }

        .outlet-stat-card .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .outlet-stat-card .stat-label {
            font-size: 0.9em;
            opacity: 1;
            color: white;
            font-weight: 600;
            margin-top: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
            letter-spacing: 0.5px;
        }

        .outlet-inventory-table h4 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .outlet-notes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .outlet-notes ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .outlet-notes li {
            margin: 8px 0;
            color: #555;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            float: none;
        }
        
        .close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-box .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .search-box .clear-search:hover {
            background: #f0f0f0;
            color: #666;
        }

        .search-box .clear-search:active {
            background: #e0e0e0;
        }

        .search-box .search-counter {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 5px 12px;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            display: none;
            z-index: 1;
        }

        .no-results-row td {
            background: #f8f9fa !important;
            border: none !important;
        }

        .no-results-row i {
            margin-bottom: 10px;
        }

        .filter-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        /* Status Select */
        .status-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }

        /* Payment Status */
        .payment-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-status.paid {
            background: #d4edda;
            color: #155724;
        }

        .payment-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-status.refunded {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        .notification.info {
            background: #17a2b8;
        }

        /* Payment status badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Alert Modal Styles - Matching Dashboard Theme */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alert-modal.show {
            opacity: 1;
        }

        .alert-modal-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .alert-modal.show .alert-modal-content {
            transform: scale(1) translateY(0);
        }

        .alert-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .alert-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alert-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .alert-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .alert-modal-body {
            padding: 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #495057;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group label i {
            margin-right: 0.5rem;
            color: #667eea;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #ffffff;
            color: #495057;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control::placeholder {
            color: #adb5bd;
        }

        .form-text {
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .delivery-methods {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            transition: all 0.2s ease;
            user-select: none;
            background: #ffffff;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .checkbox-label:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            margin-right: 0.75rem;
            position: relative;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .checkbox-label i {
            margin-right: 0.5rem;
            color: #667eea;
        }

        .schedule-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            transition: all 0.2s ease;
            user-select: none;
            background: #ffffff;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .radio-label:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
        }

        .radio-label input[type="radio"] {
            display: none;
        }

        .radiomark {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            margin-right: 0.75rem;
            position: relative;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .radio-label input[type="radio"]:checked + .radiomark {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .radio-label input[type="radio"]:checked + .radiomark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .alert-modal-footer {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .alert-modal-footer .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alert-modal-footer .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .alert-modal-footer .btn i {
            font-size: 0.9rem;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .alert-modal-content {
                width: 95%;
                margin: 1rem;
            }

            .alert-modal-body {
                padding: 1.5rem;
            }

            .delivery-methods {
                flex-direction: column;
            }

            .schedule-options {
                flex-direction: column;
            }

            .alert-modal-footer {
                flex-direction: column;
            }

            .alert-modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-tint"></i>
                <span>Abai Springs</span>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('products')">
                        <i class="fas fa-box"></i>
                        Products
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('orders')">
                        <i class="fas fa-shopping-cart"></i>
                        Orders
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('outlets')">
                        <i class="fas fa-store"></i>
                        Outlets
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('analytics')">
                        <i class="fas fa-chart-line"></i>
                        Analytics
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('users')">
                        <i class="fas fa-users"></i>
                        Users
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('payments')">
                        <i class="fas fa-credit-card"></i>
                        Payments
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('sales-management')">
                        <i class="fas fa-chart-line"></i>
                        Sales Management
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('driver-management')">
                        <i class="fas fa-truck"></i>
                        Driver Management
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('warehouse-management')">
                        <i class="fas fa-warehouse"></i>
                        Warehouse Management
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('user-management')">
                        <i class="fas fa-user-cog"></i>
                        Staff Management
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" onclick="showSection('smart-stock-alerts')">
                        <i class="fas fa-bell"></i>
                        Smart Stock Alerts
                    </a>
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section-content">
                <div class="header fade-in">
                    <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                    <p>Welcome to your Abai Springs backend management interface</p>

                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid fade-in" id="stats-grid">
                    <div class="loading">Loading statistics...</div>
                </div>
                
                <!-- Recent Activity -->
                <div class="content-grid fade-in">
                    <div class="section">
                        <h2><i class="fas fa-clock"></i> Recent Orders</h2>
                        <div id="recent-orders">
                            <div class="loading">Loading recent orders...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-chart-line"></i> Quick Actions</h2>
                        <div style="display: grid; gap: 1rem;">
                            <button class="btn btn-primary" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i> Add New Product
                            </button>
                            <button class="btn btn-success" onclick="showAddOutletModal()">
                                <i class="fas fa-store"></i> Add New Outlet
                            </button>
                            <button class="btn btn-warning" onclick="refreshData()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="products-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-box"></i> Products Management</h1>
                    <p>Manage your product inventory</p>
                </div>
                
                <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                    <div style="flex: 1; max-width: 300px;">
                        <input type="text" id="productSearch" class="form-input" placeholder="Search products..." onkeyup="searchProducts()">
                    </div>
                </div>
                
                <div class="section">
                    <h2><i class="fas fa-list"></i> All Products</h2>
                    <div id="products-table">
                        <div class="loading">Loading products...</div>
                    </div>
                </div>
            </div>
            
            <!-- Orders Section -->
            <div id="orders-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-shopping-cart"></i> Orders Management</h1>
                    <p>Track and manage customer orders</p>
                </div>
                
                <div class="section">
                    <h2><i class="fas fa-list"></i> All Orders</h2>
                    <div id="orders-table">
                        <div class="loading">Loading orders...</div>
                    </div>
                </div>
            </div>
            
            <!-- Outlets Section -->
            <div id="outlets-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-store"></i> Outlets Management</h1>
                    <p>Manage your store locations</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="showAddOutletModal()">
                        <i class="fas fa-plus"></i> Add New Outlet
                    </button>
                </div>
                
                <div class="section">
                    <h2><i class="fas fa-list"></i> All Outlets</h2>
                    <div id="outlets-table">
                        <div class="loading">Loading outlets...</div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
                    <p>Business intelligence and performance metrics</p>
                </div>
                
                <!-- Revenue Chart -->
                <div class="section">
                    <h2><i class="fas fa-dollar-sign"></i> Revenue Analytics</h2>
                    <div style="height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-box"></i> Product Performance</h2>
                        <div id="product-performance">
                            <div class="loading">Loading product performance...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-store"></i> Outlet Performance</h2>
                        <div id="outlet-performance">
                            <div class="loading">Loading outlet performance...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-number" id="total-revenue">KSH 0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-number" id="avg-order-value">KSH 0</div>
                        <div class="stat-label">Avg Order Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-number" id="low-stock-count">0</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-number" id="recent-orders-count">0</div>
                        <div class="stat-label">Recent Orders (7d)</div>
                    </div>
                </div>
            </div>
            
            <!-- Users Section -->
            <div id="users-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-users"></i> Users Management</h1>
                    <p>Manage customer accounts</p>
                </div>
                
                <div class="section">
                    <h2><i class="fas fa-list"></i> All Users</h2>
                    <div id="users-table">
                        <div class="loading">Loading users...</div>
                    </div>
                </div>
            </div>
            
            <!-- Payments Section -->
            <div id="payments-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-credit-card"></i> Payments Management</h1>
                    <p>Track and manage payment transactions</p>
                </div>
                
                <div class="section">
                    <h2><i class="fas fa-list"></i> All Payments</h2>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="payment-search" placeholder="Search payments..." onkeyup="filterPayments()">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="filter-controls">
                            <select id="payment-status-filter" onchange="filterPayments()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <select id="payment-method-filter" onchange="filterPayments()">
                                <option value="">All Methods</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="airtel_money">Airtel Money</option>
                                <option value="equitel">Equitel</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div id="payments-table">
                        <div class="loading">Loading payments...</div>
                    </div>
                </div>
            </div>
            
            <!-- Sales Management Section -->
            <div id="sales-management-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-chart-line"></i> Sales Management</h1>
                    <p>Manage sales team, performance, and customer relationships</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-number" id="total-salespeople">-</div>
                        <div class="stat-label">Sales Team</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-number" id="total-sales">-</div>
                        <div class="stat-label">Total Sales (KSH)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-number" id="sales-growth">-</div>
                        <div class="stat-label">Growth %</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸŽ¯</div>
                        <div class="stat-number" id="target-achievement">-</div>
                        <div class="stat-label">Target Achievement</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-users"></i> Sales Team</h2>
                        <div class="table-controls">
                            <button class="btn btn-primary" onclick="showAddSalespersonModal()">
                                <i class="fas fa-plus"></i> Add Salesperson
                            </button>
                            <div class="search-box">
                                <input type="text" id="sales-search" placeholder="Search salespeople..." onkeyup="filterSalespeople()">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="salespeople-table">
                            <div class="loading">Loading sales team...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-trophy"></i> Performance Leaderboard</h2>
                        <div id="sales-leaderboard">
                            <div class="loading">Loading performance data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Salesperson Modal -->
            <div id="addSalespersonModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-user-plus"></i> Add New Salesperson</h2>
                        <span class="close" onclick="closeAddSalespersonModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addSalespersonForm">
                            <div class="form-group">
                                <label for="salespersonName">Full Name *</label>
                                <input type="text" id="salespersonName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="salespersonPhone">Phone Number *</label>
                                <input type="tel" id="salespersonPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="salespersonEmail">Email Address</label>
                                <input type="email" id="salespersonEmail" name="email" placeholder="salesperson@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="salespersonTerritory">Sales Territory</label>
                                <select id="salespersonTerritory" name="territory">
                                    <option value="">Select Territory</option>
                                    <option value="nairobi-central">Nairobi Central</option>
                                    <option value="nairobi-west">Nairobi West</option>
                                    <option value="nairobi-east">Nairobi East</option>
                                    <option value="nairobi-south">Nairobi South</option>
                                    <option value="nairobi-north">Nairobi North</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salespersonTarget">Monthly Sales Target (KSH)</label>
                                <input type="number" id="salespersonTarget" name="target" placeholder="50000">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddSalespersonModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Salesperson</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Salesperson Modal -->
            <div id="editSalespersonModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-user-edit"></i> Edit Salesperson</h2>
                        <span class="close" onclick="closeEditSalespersonModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editSalespersonForm">
                            <input type="hidden" id="editSalespersonId" name="id">
                            <div class="form-group">
                                <label for="editSalespersonName">Full Name *</label>
                                <input type="text" id="editSalespersonName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="editSalespersonPhone">Phone Number *</label>
                                <input type="tel" id="editSalespersonPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="editSalespersonEmail">Email Address</label>
                                <input type="email" id="editSalespersonEmail" name="email" placeholder="salesperson@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="editSalespersonTerritory">Sales Territory</label>
                                <select id="editSalespersonTerritory" name="territory">
                                    <option value="">Select Territory</option>
                                    <option value="nairobi-central">Nairobi Central</option>
                                    <option value="nairobi-west">Nairobi West</option>
                                    <option value="nairobi-east">Nairobi East</option>
                                    <option value="nairobi-south">Nairobi South</option>
                                    <option value="nairobi-north">Nairobi North</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editSalespersonTarget">Monthly Sales Target (KSH)</label>
                                <input type="number" id="editSalespersonTarget" name="target" placeholder="50000">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeEditSalespersonModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Salesperson</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Add Staff Member Modal -->
            <div id="addStaffModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-user-plus"></i> Add New Staff Member</h2>
                        <span class="close" onclick="closeAddStaffModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addStaffForm">
                            <div class="form-group">
                                <label for="staffName">Full Name *</label>
                                <input type="text" id="staffName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="staffEmail">Email Address *</label>
                                <input type="email" id="staffEmail" name="email" required placeholder="staff@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="staffPhone">Phone Number *</label>
                                <input type="tel" id="staffPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="staffRole">Role *</label>
                                <select id="staffRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="sales">Sales</option>
                                    <option value="driver">Driver</option>
                                    <option value="warehouse">Warehouse</option>
                                    <option value="manager">Manager</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staffDepartment">Department</label>
                                <select id="staffDepartment" name="department">
                                    <option value="">Select Department</option>
                                    <option value="sales">Sales</option>
                                    <option value="operations">Operations</option>
                                    <option value="logistics">Logistics</option>
                                    <option value="administration">Administration</option>
                                    <option value="finance">Finance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staffStatus">Status</label>
                                <select id="staffStatus" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddStaffModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Staff Member</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Staff Member Modal -->
            <div id="editStaffModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-user-edit"></i> Edit Staff Member</h2>
                        <span class="close" onclick="closeEditStaffModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editStaffForm">
                            <input type="hidden" id="editStaffId" name="id">
                            <div class="form-group">
                                <label for="editStaffName">Full Name *</label>
                                <input type="text" id="editStaffName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="editStaffEmail">Email Address *</label>
                                <input type="email" id="editStaffEmail" name="email" required placeholder="staff@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="editStaffPhone">Phone Number *</label>
                                <input type="tel" id="editStaffPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="editStaffRole">Role *</label>
                                <select id="editStaffRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="sales">Sales</option>
                                    <option value="driver">Driver</option>
                                    <option value="warehouse">Warehouse</option>
                                    <option value="manager">Manager</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editStaffDepartment">Department</label>
                                <select id="editStaffDepartment" name="department">
                                    <option value="">Select Department</option>
                                    <option value="sales">Sales</option>
                                    <option value="operations">Operations</option>
                                    <option value="logistics">Logistics</option>
                                    <option value="administration">Administration</option>
                                    <option value="finance">Finance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editStaffStatus">Status</label>
                                <select id="editStaffStatus" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeEditStaffModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Staff Member</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Add Stock Movement Modal -->
            <div id="addStockMovementModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-boxes"></i> Add Stock Movement</h2>
                        <span class="close" onclick="closeAddStockMovementModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addStockMovementForm">
                            <div class="form-group">
                                <label for="movementType">Movement Type *</label>
                                <select id="movementType" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="inbound">Inbound (Stock In)</option>
                                    <option value="outbound">Outbound (Stock Out)</option>
                                    <option value="transfer">Transfer (Between Locations)</option>
                                    <option value="adjustment">Stock Adjustment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productName">Product *</label>
                                <select id="productName" name="product" required>
                                    <option value="">Select Product</option>
                                    <!-- Products will be dynamically loaded from database -->
                                </select>
                            </div>
                            <div class="form-group" id="sourceLocationGroup">
                                <label for="sourceLocation">Source Location *</label>
                                <select id="sourceLocation" name="fromLocation">
                                    <option value="">Select Source</option>
                                </select>
                            </div>
                            <div class="form-group" id="destinationLocationGroup">
                                <label for="destinationLocation">Destination Location *</label>
                                <select id="destinationLocation" name="toLocation">
                                    <option value="">Select Destination</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="movementQuantity">Quantity *</label>
                                <input type="number" id="movementQuantity" name="quantity" required min="1" placeholder="Enter quantity">
                            </div>
                            <div class="form-group">
                                <label for="movementDate">Movement Date *</label>
                                <input type="date" id="movementDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="movementReason">Reason</label>
                                <select id="movementReason" name="reason">
                                    <option value="">Select Reason</option>
                                    <option value="purchase">Purchase Order</option>
                                    <option value="sale">Customer Sale</option>
                                    <option value="transfer">Location Transfer</option>
                                    <option value="damage">Damage/Loss</option>
                                    <option value="expiry">Expiry</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="movementNotes">Notes</label>
                                <textarea id="movementNotes" name="notes" rows="3" placeholder="Additional notes about this movement"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddStockMovementModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Stock Movement</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Stock Movement Modal -->
            <div id="editStockMovementModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-edit"></i> Edit Stock Movement</h2>
                        <span class="close" onclick="closeEditStockMovementModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editStockMovementForm">
                            <input type="hidden" id="editMovementId" name="id">
                            <div class="form-group">
                                <label for="editMovementType">Movement Type *</label>
                                <select id="editMovementType" name="type" required>
                                    <option value="inbound">Inbound (Stock In)</option>
                                    <option value="outbound">Outbound (Stock Out)</option>
                                    <option value="transfer">Transfer (Between Locations)</option>
                                    <option value="adjustment">Stock Adjustment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editProductName">Product *</label>
                                <select id="editProductName" name="product" required>
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group" id="editSourceLocationGroup">
                                <label for="editSourceLocation">Source Location *</nlabel>
                                <select id="editSourceLocation" name="fromLocation">
                                    <option value="">Select Source</option>
                                </select>
                            </div>
                            <div class="form-group" id="editDestinationLocationGroup">
                                <label for="editDestinationLocation">Destination Location *</label>
                                <select id="editDestinationLocation" name="toLocation">
                                    <option value="">Select Destination</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editMovementQuantity">Quantity *</label>
                                <input type="number" id="editMovementQuantity" name="quantity" required min="1">
                            </div>
                            <div class="form-group">
                                <label for="editMovementDate">Movement Date *</label>
                                <input type="date" id="editMovementDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="editMovementReason">Reason</label>
                                <select id="editMovementReason" name="reason">
                                    <option value="purchase">Purchase Order</option>
                                    <option value="sale">Customer Sale</option>
                                    <option value="transfer">Location Transfer</option>
                                    <option value="damage">Damage/Loss</option>
                                    <option value="expiry">Expiry</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeEditStockMovementModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Add Driver Modal -->
            <div id="addDriverModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-truck"></i> Add New Driver</h2>
                        <span class="close" onclick="closeAddDriverModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addDriverForm">
                            <div class="form-group">
                                <label for="driverName">Full Name *</label>
                                <input type="text" id="driverName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="driverPhone">Phone Number *</label>
                                <input type="tel" id="driverPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="driverEmail">Email Address</label>
                                <input type="email" id="driverEmail" name="email" placeholder="driver@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="driverLicense">Driver License Number *</label>
                                <input type="text" id="driverLicense" name="license" required placeholder="Enter license number">
                            </div>
                            <div class="form-group">
                                <label for="driverVehicle">Vehicle Details</label>
                                <input type="text" id="driverVehicle" name="vehicle" placeholder="Vehicle make, model, plate number">
                            </div>
                            <div class="form-group">
                                <label for="driverTerritory">Delivery Territory</label>
                                <select id="driverTerritory" name="territory">
                                    <option value="">Select Territory</option>
                                    <option value="nairobi-central">Nairobi Central</option>
                                    <option value="nairobi-west">Nairobi West</option>
                                    <option value="nairobi-east">Nairobi East</option>
                                    <option value="nairobi-south">Nairobi South</option>
                                    <option value="nairobi-north">Nairobi North</option>
                                    <option value="kiambu">Kiambu County</option>
                                    <option value="machakos">Machakos County</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="driverStatus">Status</label>
                                <select id="driverStatus" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="on-leave">On Leave</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddDriverModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Driver</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Driver Modal -->
            <div id="editDriverModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-truck"></i> Edit Driver</h2>
                        <span class="close" onclick="closeEditDriverModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editDriverForm">
                            <input type="hidden" id="editDriverId" name="id">
                            <div class="form-group">
                                <label for="editDriverName">Full Name *</label>
                                <input type="text" id="editDriverName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="editDriverPhone">Phone Number *</label>
                                <input type="tel" id="editDriverPhone" name="phone" required placeholder="+254 700 000 000">
                            </div>
                            <div class="form-group">
                                <label for="editDriverEmail">Email Address</label>
                                <input type="email" id="editDriverEmail" name="email" placeholder="driver@abaisprings.com">
                            </div>
                            <div class="form-group">
                                <label for="editDriverLicense">Driver License Number *</label>
                                <input type="text" id="editDriverLicense" name="license" required placeholder="Enter license number">
                            </div>
                            <div class="form-group">
                                <label for="editDriverVehicle">Vehicle Details</label>
                                <input type="text" id="editDriverVehicle" name="vehicle" placeholder="Vehicle make, model, plate number">
                            </div>
                            <div class="form-group">
                                <label for="editDriverTerritory">Delivery Territory</label>
                                <select id="editDriverTerritory" name="territory">
                                    <option value="">Select Territory</option>
                                    <option value="nairobi-central">Nairobi Central</option>
                                    <option value="nairobi-west">Nairobi West</option>
                                    <option value="nairobi-east">Nairobi East</option>
                                    <option value="nairobi-south">Nairobi South</option>
                                    <option value="nairobi-north">Nairobi North</option>
                                    <option value="kiambu">Kiambu County</option>
                                    <option value="machakos">Machakos County</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editDriverStatus">Status</label>
                                <select id="editDriverStatus" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="on-leave">On Leave</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeEditDriverModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Driver</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Driver Management Section -->
            <div id="driver-management-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-truck"></i> Driver Management</h1>
                    <p>Manage delivery drivers and track deliveries</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸšš</div>
                        <div class="stat-number" id="total-drivers">-</div>
                        <div class="stat-label">Active Drivers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“¦</div>
                        <div class="stat-number" id="total-deliveries">-</div>
                        <div class="stat-label">Today's Deliveries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-number" id="completed-deliveries">-</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â±ï¸</div>
                        <div class="stat-number" id="avg-delivery-time">-</div>
                        <div class="stat-label">Avg Delivery Time</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-users"></i> Driver Team</h2>
                        <div class="table-controls">
                            <button class="btn btn-primary" onclick="showAddDriverModal()">
                                <i class="fas fa-plus"></i> Add Driver
                            </button>
                            <div class="search-box">
                                <input type="text" id="driver-search" placeholder="Search drivers..." onkeyup="filterDrivers()">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="drivers-table">
                            <div class="loading">Loading drivers...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-route"></i> Active Deliveries</h2>
                        <div id="active-deliveries">
                            <div class="loading">Loading active deliveries...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Warehouse Management Section -->
            <div id="warehouse-management-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-warehouse"></i> Warehouse Management</h1>
                    <p>Manage inventory, stock movements, and warehouse operations</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“¦</div>
                        <div class="stat-number" id="total-inventory">-</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âš ï¸</div>
                        <div class="stat-number" id="low-stock-items">-</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-number" id="inventory-value">-</div>
                        <div class="stat-label">Inventory Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-number" id="stock-movements">-</div>
                        <div class="stat-label">Today's Movements</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-boxes"></i> Current Inventory</h2>
                        <div class="table-controls">
                            <button class="btn btn-primary" onclick="showStockMovementModal()">
                                <i class="fas fa-plus"></i> Add Stock Movement
                            </button>
                            <div class="search-box">
                                <input type="text" id="inventory-search" placeholder="Search inventory... (Press Esc to clear)" onkeyup="filterInventory()" oninput="filterInventory()">
                                <i class="fas fa-search"></i>
                                <button type="button" class="clear-search" onclick="clearInventorySearch()" title="Clear search (Esc)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="inventory-table">
                            <div class="loading">Loading inventory...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-chart-bar"></i> Stock Movements</h2>
                        <div id="stock-movements-table">
                            <div class="loading">Loading stock movements...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-store"></i> Outlet Inventory</h2>
                        <div class="table-controls">
                            <select id="outlet-selector" onchange="loadOutletInventory()">
                                <option value="">Select Outlet</option>
                                <!-- Outlets will be dynamically loaded -->
                            </select>
                            <button class="btn btn-info btn-sm" onclick="loadOutletInventory()" style="margin-left: 10px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="outlet-inventory-table">
                            <div class="loading">Select an outlet to view inventory...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Management Section -->
            <div id="user-management-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-user-cog"></i> Staff Management</h1>
                    <p>Manage staff accounts, roles, and permissions</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-number" id="total-staff">-</div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’¼</div>
                        <div class="stat-number" id="active-staff">-</div>
                        <div class="stat-label">Active Staff</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ”</div>
                        <div class="stat-number" id="roles-count">-</div>
                        <div class="stat-label">User Roles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“…</div>
                        <div class="stat-number" id="recent-logins">-</div>
                        <div class="stat-label">Recent Logins</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-users"></i> Staff Accounts</h2>
                        <div class="table-controls">
                            <button class="btn btn-primary" onclick="showAddStaffModal()">
                                <i class="fas fa-plus"></i> Add Staff Member
                            </button>
                            
                            <div class="search-box">
                                <input type="text" id="staff-search" placeholder="Search staff..." onkeyup="filterStaff()">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="staff-table">
                            <div class="loading">Loading staff...</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-shield-alt"></i> Role Permissions</h2>
                        <div id="role-permissions">
                            <div class="loading">Loading role permissions...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Smart Stock Alerts Section -->
            <div id="smart-stock-alerts-section" class="section-content" style="display: none;">
                <div class="header">
                    <h1><i class="fas fa-bell"></i> Smart Stock Alerts</h1>
                    <p>Monitor and manage intelligent stock alert system</p>
                </div>
                
                <!-- Alert Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ””</div>
                        <div class="stat-number" id="total-alerts">-</div>
                        <div class="stat-label">Total Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-number" id="enabled-alerts">-</div>
                        <div class="stat-label">Enabled Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âš ï¸</div>
                        <div class="stat-number" id="alerts-needing-attention">-</div>
                        <div class="stat-label">Need Attention</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âš™ï¸</div>
                        <div class="stat-number" id="monitoring-status">-</div>
                        <div class="stat-label">Monitoring Status</div>
                    </div>
                </div>
                
                <!-- Control Panel -->
                <div class="content-grid">
                    <div class="section">
                        <h2><i class="fas fa-cogs"></i> System Controls</h2>
                        <div class="table-controls">
                            <button class="btn btn-success" onclick="startMonitoring()">
                                <i class="fas fa-play"></i> Start Monitoring
                            </button>
                            <button class="btn btn-danger" onclick="stopMonitoring()">
                                <i class="fas fa-stop"></i> Stop Monitoring
                            </button>
                            <button class="btn btn-warning" onclick="refreshAlertStats()">
                                <i class="fas fa-sync"></i> Refresh Statistics
                            </button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2><i class="fas fa-flask"></i> Test & Management</h2>
                        <div class="table-controls">
                            <button class="btn btn-info" onclick="showTestAlertModal()">
                                <i class="fas fa-paper-plane"></i> Send Test Alert
                            </button>
                            <button class="btn btn-secondary" onclick="viewAlertHistory()">
                                <i class="fas fa-history"></i> View Alert History
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Active Alerts Table -->
                <div class="section">
                    <h2><i class="fas fa-list"></i> Active Stock Alerts</h2>
                    <div id="stock-alerts-table">
                        <div class="loading">Loading stock alerts...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
            <h2><i class="fas fa-plus"></i> Add New Product</h2>
                <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            </div>
            <div class="modal-body">
            <form id="addProductForm">
                <div class="form-group">
                        <label for="productName">Product Name *</label>
                        <input type="text" id="productName" class="form-input" name="name" required placeholder="Enter product name">
                </div>
                <div class="form-group">
                        <label for="productBrand">Brand *</label>
                        <select id="productBrand" class="form-input" name="brand" required>
                        <option value="Abai Springs">Abai Springs</option>
                        <option value="Sprinkle">Sprinkle</option>
                    </select>
                </div>
                <div class="form-group">
                        <label for="productCategory">Category *</label>
                        <select id="productCategory" class="form-input" name="category" required>
                        <option value="500ml">500ml</option>
                        <option value="1 Litre">1 Litre</option>
                        <option value="2 Litre">2 Litre</option>
                        <option value="5 Litre">5 Litre</option>
                        <option value="10 Litre">10 Litre</option>
                        <option value="20 Litre">20 Litre</option>
                    </select>
                </div>
                <div class="form-group">
                        <label for="productPrice">Price (KSH) *</label>
                        <input type="number" id="productPrice" class="form-input" name="price" required placeholder="Enter price">
                </div>
                <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" class="form-input" name="description" rows="3" placeholder="Enter product description"></textarea>
                </div>
                <div class="form-group">
                        <label for="productStock">Stock Level *</label>
                        <input type="number" id="productStock" class="form-input" name="stockLevel" value="0" required placeholder="Enter stock level">
                </div>
                <div class="form-group">
                        <label for="productImage">Image URL</label>
                        <input type="text" id="productImage" class="form-input" name="image" placeholder="Enter image URL (optional)">
                </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
                    </div>
            </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Product</h2>
                <span class="close" onclick="closeModal('editProductModal')">&times;</span>
            </div>
            <div class="modal-body">
            <form id="editProductForm">
                <input type="hidden" name="productId" id="editProductId">
                <div class="form-group">
                        <label for="editProductName">Product Name *</label>
                        <input type="text" id="editProductName" class="form-input" name="name" required placeholder="Enter product name">
                </div>
                <div class="form-group">
                        <label for="editProductBrand">Brand *</label>
                        <select id="editProductBrand" class="form-input" name="brand" required>
                        <option value="Abai Springs">Abai Springs</option>
                        <option value="Sprinkle">Sprinkle</option>
                    </select>
                </div>
                <div class="form-group">
                        <label for="editProductCategory">Category *</label>
                        <select id="editProductCategory" class="form-input" name="category" required>
                        <option value="500ml">500ml</option>
                        <option value="1 Litre">1 Litre</option>
                        <option value="2 Litre">2 Litre</option>
                        <option value="5 Litre">5 Litre</option>
                        <option value="10 Litre">10 Litre</option>
                        <option value="20 Litre">20 Litre</option>
                    </select>
                </div>
                <div class="form-group">
                        <label for="editProductPrice">Price (KSH) *</label>
                        <input type="number" id="editProductPrice" class="form-input" name="price" required placeholder="Enter price">
                </div>
                <div class="form-group">
                        <label for="editProductDescription">Description</label>
                        <textarea id="editProductDescription" class="form-input" name="description" rows="3" placeholder="Enter product description"></textarea>
                </div>
                <div class="form-group">
                        <label for="editProductStock">Stock Level *</label>
                        <input type="number" id="editProductStock" class="form-input" name="stockLevel" required placeholder="Enter stock level">
                </div>
                <div class="form-group">
                        <label for="editProductImage">Image URL</label>
                        <input type="text" id="editProductImage" class="form-input" name="image" placeholder="Enter image URL (optional)">
                </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editProductModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
            </form>
            </div>
        </div>
    </div>
    
    <!-- Add Outlet Modal -->
    <div id="addOutletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
            <h2><i class="fas fa-store"></i> Add New Outlet</h2>
                <span class="close" onclick="closeModal('addOutletModal')">&times;</span>
            </div>
            <div class="modal-body">
            <form id="addOutletForm">
                <div class="form-group">
                        <label for="outletName">Outlet Name *</label>
                        <input type="text" id="outletName" class="form-input" name="name" required placeholder="Enter outlet name">
                </div>
                <div class="form-group">
                        <label for="outletAddress">Address *</label>
                        <input type="text" id="outletAddress" class="form-input" name="address" required placeholder="Enter outlet address">
                </div>
                <div class="form-group">
                        <label for="outletPhone">Phone *</label>
                        <input type="text" id="outletPhone" class="form-input" name="phone" required placeholder="Enter phone number">
                </div>
                <div class="form-group">
                        <label for="outletEmail">Email *</label>
                        <input type="email" id="outletEmail" class="form-input" name="email" required placeholder="Enter email address">
                </div>
                <div class="form-group">
                        <label for="outletLat">Latitude *</label>
                        <input type="number" id="outletLat" step="any" class="form-input" name="lat" placeholder="Enter latitude (optional)">
                </div>
                <div class="form-group">
                        <label for="outletLng">Longitude *</label>
                        <input type="number" id="outletLng" step="any" class="form-input" name="lng" placeholder="Enter longitude (optional)">
                </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addOutletModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Outlet</button>
                    </div>
            </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Outlet Modal -->
    <div id="editOutletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Outlet</h2>
                <span class="close" onclick="closeModal('editOutletModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editOutletForm">
                    <input type="hidden" id="editOutletId" name="outletId">
                    <div class="form-group">
                        <label for="editOutletName">Outlet Name *</label>
                        <input type="text" id="editOutletName" class="form-input" name="name" required placeholder="Enter outlet name">
                    </div>
                    <div class="form-group">
                        <label for="editOutletAddress">Address *</label>
                        <input type="text" id="editOutletAddress" class="form-input" name="address" required placeholder="Enter outlet address">
                    </div>
                    <div class="form-group">
                        <label for="editOutletPhone">Phone *</label>
                        <input type="text" id="editOutletPhone" class="form-input" name="phone" required placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label for="editOutletEmail">Email *</label>
                        <input type="email" id="editOutletEmail" class="form-input" name="email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="editOutletLat">Latitude *</label>
                        <input type="number" id="editOutletLat" step="any" class="form-input" name="lat" placeholder="Enter latitude (optional)">
                    </div>
                    <div class="form-group">
                        <label for="editOutletLng">Longitude *</label>
                        <input type="number" id="editOutletLng" step="any" class="form-input" name="lng" placeholder="Enter longitude (optional)">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editOutletModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        
        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Load data for the section
            loadSectionData(sectionName);
        }
        
        // Load data for different sections
        async function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    await loadDashboardData();
                    break;
                case 'products':
                    await loadProducts();
                    break;
                case 'orders':
                    await loadOrders();
                    break;
                case 'outlets':
                    await loadOutlets();
                    break;
                case 'analytics':
                    await loadAnalytics();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'payments':
                    await loadPayments();
                    break;
                case 'sales-management':
                    await loadSalesManagementData();
                    break;
                case 'driver-management':
                    await loadDriverManagementData();
                    break;
                case 'warehouse-management':
                    await loadWarehouseManagementData();
                    break;
                case 'user-management':
                    await loadStaffManagementData();
                    break;
                case 'smart-stock-alerts':
                    await loadSmartStockAlerts();
                    break;
                    break;
            }
        }
        
        // Dashboard data
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                const [products, outlets, orders, users] = await Promise.all([
                    fetch(`${API_BASE_URL}/products`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/outlets`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/orders`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/auth/users`).then(r => r.json()).catch(() => ({success: true, data: []}))
                ]);
                
                console.log('API responses:', { products, outlets, orders, users });
                
                // Update stats
                const statsGrid = document.getElementById('stats-grid');
                
                // Safe data access with fallbacks
                const productsCount = (products && products.success && products.data) ? products.data.length : 0;
                const outletsCount = (outlets && outlets.success && outlets.data) ? outlets.data.length : 0;
                const ordersCount = (orders && orders.success && orders.data) ? orders.data.length : 0;
                const usersCount = (users && users.success && users.data) ? users.data.length : 0;
                
                console.log('Updating stats grid with:', {
                    productsCount,
                    outletsCount,
                    ordersCount,
                    usersCount
                });
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-number">${productsCount}</div>
                        <div class="stat-label">Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-store"></i></div>
                        <div class="stat-number">${outletsCount}</div>
                        <div class="stat-label">Outlets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-number">${ordersCount}</div>
                        <div class="stat-label">Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-number">${usersCount}</div>
                        <div class="stat-label">Users</div>
                    </div>
                `;
                
                // Update recent orders
                const recentOrders = document.getElementById('recent-orders');
                if (orders && orders.success && orders.data && orders.data.length > 0) {
                    const recent = orders.data.slice(0, 5);
                    recentOrders.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recent.map(order => `
                                    <tr>
                                        <td>#${order._id.slice(-6)}</td>
                                        <td>${order.customerName || 'N/A'}</td>
                                        <td>KSH ${order.totalAmount || 0}</td>
                                        <td><span class="btn btn-${order.status === 'completed' ? 'success' : 'warning'}">${order.status || 'pending'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    recentOrders.innerHTML = '<p>No recent orders</p>';
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        // Load products
        async function loadProducts(searchTerm = '') {
            try {
                const url = searchTerm ? `${API_BASE_URL}/products?search=${encodeURIComponent(searchTerm)}&t=${Date.now()}` : `${API_BASE_URL}/products?t=${Date.now()}`;
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                
                const productsTable = document.getElementById('products-table');
                if (data.success && data.data.length > 0) {
                    productsTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(product => `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${product.brand}</td>
                                        <td>${product.category}</td>
                                        <td>KSH ${product.price}</td>
                                        <td>${product.stockLevel}</td>
                                        <td>
                                            <button class="btn btn-warning" onclick="editProduct('${product._id}')">Edit</button>
                                            <button class="btn btn-danger" onclick="deleteProduct('${product._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    productsTable.innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-table').innerHTML = '<p>Error loading products</p>';
            }
        }
        
        // Search products function
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value;
            loadProducts(searchTerm);
        }
        
        // Edit product function
        async function editProduct(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    const product = data.data;
                    showEditProductModal(product);
                } else {
                    alert('Error loading product details');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Error loading product details');
            }
        }
        
        // Delete product function
        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Product deleted successfully!');
                        await loadProducts();
                        await loadDashboardData(); // Refresh dashboard stats
                    } else {
                        alert('Error deleting product: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }
        
        // Restore product function
        async function restoreProduct(productId) {
            if (confirm('Are you sure you want to restore this product?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ isActive: true })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Product restored successfully!');
                        loadProducts();
                        loadDashboardData(); // Refresh dashboard stats
                    } else {
                        alert('Error restoring product: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error restoring product:', error);
                    alert('Error restoring product');
                }
            }
        }
        
        // Permanently delete product function
        async function permanentlyDeleteProduct(productId) {
            if (confirm('Are you sure you want to PERMANENTLY delete this product? This action cannot be undone!')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/products/${productId}/permanent`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Product permanently deleted!');
                        loadProducts();
                        loadDashboardData(); // Refresh dashboard stats
                    } else {
                        alert('Error permanently deleting product: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error permanently deleting product:', error);
                    alert('Error permanently deleting product');
                }
            }
        }
        
        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders`);
                const data = await response.json();
                
                const ordersTable = document.getElementById('orders-table');
                if (data.success && data.data.length > 0) {
                    ordersTable.innerHTML = `
                        <div class="table-controls">
                            <div class="search-box">
                                <input type="text" id="order-search" placeholder="Search orders..." onkeyup="filterOrders()">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="filter-controls">
                                <select id="status-filter" onchange="filterOrders()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="preparing">Preparing</option>
                                    <option value="out_for_delivery">Out for Delivery</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table" id="orders-data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(order => `
                                    <tr data-order-id="${order._id}" data-status="${order.status}">
                                        <td>#${order._id.slice(-8).toUpperCase()}</td>
                                        <td>${order.customer?.name || order.notes?.split(',')[0]?.replace('Customer: ', '') || 'N/A'}</td>
                                        <td>${order.notes?.split(',')[1]?.replace(' Phone: ', '') || 'N/A'}</td>
                                        <td>${order.items ? order.items.length : 0} items</td>
                                        <td>KSH ${(order.totalAmount || 0).toLocaleString()}</td>
                                        <td>
                                            <select class="status-select" onchange="updateOrderStatus('${order._id}', this.value)">
                                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                                <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                        </td>
                                        <td>
                                            <span class="payment-status ${order.paymentStatus}">${order.paymentStatus?.toUpperCase() || 'PENDING'}</span>
                                        </td>
                                        <td>${new Date(order.createdAt).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}</td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewOrderDetails('${order._id}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="editOrder('${order._id}')" title="Edit Order">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order._id}')" title="Delete Order">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    ordersTable.innerHTML = '<p>No orders found</p>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-table').innerHTML = '<p>Error loading orders</p>';
            }
        }

        // Filter orders
        function filterOrders() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const rows = document.querySelectorAll('#orders-data-table tbody tr');

            rows.forEach(row => {
                const orderId = row.cells[0].textContent.toLowerCase();
                const customer = row.cells[1].textContent.toLowerCase();
                const phone = row.cells[2].textContent.toLowerCase();
                const status = row.getAttribute('data-status');

                const matchesSearch = orderId.includes(searchTerm) || 
                                   customer.includes(searchTerm) || 
                                   phone.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;

                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        // Update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Order status updated successfully', 'success');
                    // Update the data attribute
                    const row = document.querySelector(`[data-order-id="${orderId}"]`);
                    if (row) {
                        row.setAttribute('data-status', newStatus);
                    }
                } else {
                    showNotification('Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Error updating order status', 'error');
            }
        }

        // View order details
        function viewOrderDetails(orderId) {
            // This would typically open a modal with order details
            alert(`Viewing order details for ${orderId}`);
        }

        // Edit order
        function editOrder(orderId) {
            // This would typically open an edit modal
            alert(`Editing order ${orderId}`);
        }

        // Delete order
        async function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (data.success) {
                        showNotification('Order deleted successfully', 'success');
                        loadOrders(); // Reload the table
                    } else {
                        showNotification('Failed to delete order', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    showNotification('Error deleting order', 'error');
                }
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Load outlets
        async function loadOutlets() {
            try {
                const response = await fetch(`${API_BASE_URL}/outlets`);
                const data = await response.json();
                
                const outletsTable = document.getElementById('outlets-table');
                if (data.success && data.data.length > 0) {
                    outletsTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(outlet => `
                                    <tr>
                                        <td>${outlet.name}</td>
                                        <td>${outlet.address}</td>
                                        <td>${outlet.phone}</td>
                                        <td>${outlet.email}</td>
                                        <td><span class="btn btn-${outlet.isActive ? 'success' : 'danger'}">${outlet.isActive ? 'Active' : 'Inactive'}</span></td>
                                        <td>
                                            <button class="btn btn-warning" onclick="editOutlet('${outlet._id}')">Edit</button>
                                            <button class="btn btn-danger" onclick="deleteOutlet('${outlet._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    outletsTable.innerHTML = '<p>No outlets found</p>';
                }
            } catch (error) {
                console.error('Error loading outlets:', error);
                document.getElementById('outlets-table').innerHTML = '<p>Error loading outlets</p>';
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            try {
                // Load summary analytics
                const summaryResponse = await fetch(`${API_BASE_URL}/analytics/summary`);
                const summaryData = await summaryResponse.json();
                
                if (summaryData.success) {
                    // Update summary cards
                    document.getElementById('total-revenue').textContent = `KSH ${summaryData.data.totalRevenue.toLocaleString()}`;
                    document.getElementById('avg-order-value').textContent = `KSH ${summaryData.data.averageOrderValue.toLocaleString()}`;
                    document.getElementById('low-stock-count').textContent = summaryData.data.lowStockProducts;
                    document.getElementById('recent-orders-count').textContent = summaryData.data.recentOrders;
                }
                
                // Load revenue chart
                const revenueResponse = await fetch(`${API_BASE_URL}/analytics/revenue`);
                const revenueData = await revenueResponse.json();
                
                if (revenueData.success) {
                    createRevenueChart(revenueData.data.dailyRevenue);
                }
                
                // Load product performance
                const productResponse = await fetch(`${API_BASE_URL}/analytics/products`);
                const productData = await productResponse.json();
                
                if (productData.success) {
                    displayProductPerformance(productData.data);
                }
                
                // Load outlet performance
                const outletResponse = await fetch(`${API_BASE_URL}/analytics/outlets`);
                const outletData = await outletResponse.json();
                
                if (outletData.success) {
                    displayOutletPerformance(outletData.data);
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        // Create revenue chart
        function createRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }
            
            const labels = revenueData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const data = revenueData.map(item => item.revenue);
            
            window.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Revenue (KSH)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSH ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Display product performance
        function displayProductPerformance(products) {
            const container = document.getElementById('product-performance');
            
            if (products.length > 0) {
                const topProducts = products.slice(0, 5); // Show top 5
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Brand</th>
                                <th>Sold</th>
                                <th>Revenue</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topProducts.map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${product.brand}</td>
                                    <td>${product.totalSold}</td>
                                    <td>KSH ${product.totalRevenue.toLocaleString()}</td>
                                    <td>${product.stockLevel}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = '<p>No product performance data available</p>';
            }
        }
        
        // Display outlet performance
        function displayOutletPerformance(outlets) {
            const container = document.getElementById('outlet-performance');
            
            if (outlets.length > 0) {
                const topOutlets = outlets.slice(0, 5); // Show top 5
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Outlet</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Avg Order</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topOutlets.map(outlet => `
                                <tr>
                                    <td>${outlet.name}</td>
                                    <td>${outlet.totalOrders}</td>
                                    <td>KSH ${outlet.totalRevenue.toLocaleString()}</td>
                                    <td>KSH ${outlet.averageOrderValue.toLocaleString()}</td>
                                    <td><span class="btn btn-${outlet.isActive ? 'success' : 'danger'}">${outlet.isActive ? 'Active' : 'Inactive'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = '<p>No outlet performance data available</p>';
            }
        }
        
        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/users`);
                const data = await response.json();
                
                const usersTable = document.getElementById('users-table');
                if (data.success && data.data.length > 0) {
                    usersTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(user => `
                                    <tr>
                                        <td>${user.name || 'N/A'}</td>
                                        <td>${user.email}</td>
                                        <td>${user.phone || 'N/A'}</td>
                                        <td>${user.role || 'customer'}</td>
                                        <td>
                                            <button class="btn btn-warning" onclick="editUser('${user._id}')">Edit</button>
                                            <button class="btn btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    usersTable.innerHTML = '<p>No users found</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table').innerHTML = '<p>Error loading users</p>';
            }
        }
        
        // Modal functions
        function showAddProductModal() {
            console.log('showAddProductModal called');
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal displayed');
            } else {
                console.error('Modal not found');
            }
        }
        
        function showEditProductModal(product) {
            // Populate the edit form with product data
            document.getElementById('editProductId').value = product._id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductBrand').value = product.brand;
            document.getElementById('editProductCategory').value = product.category;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editProductStock').value = product.stockLevel;
            document.getElementById('editProductImage').value = product.image || '';
            
            document.getElementById('editProductModal').style.display = 'block';
        }
        
        function showAddOutletModal() {
            document.getElementById('addOutletModal').style.display = 'block';
        }

        function showAddSalespersonModal() {
            document.getElementById('addSalespersonModal').style.display = 'block';
        }

        function showAddDriverModal() {
            document.getElementById('addDriverModal').style.display = 'block';
        }

        function showAddStaffModal() {
            document.getElementById('addStaffModal').style.display = 'block';
        }

        function showStockMovementModal() {
            // Delegate to the enhanced modal opener that also populates products
            if (typeof showAddStockMovementModal === 'function') {
                showAddStockMovementModal();
            } else {
            document.getElementById('addStockMovementModal').style.display = 'block';
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Form submissions
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE_URL}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Product added successfully!');
                    closeModal('addProductModal');
                    e.target.reset();
                    await loadProducts();
                    await loadDashboardData(); // Refresh dashboard stats
                } else {
                    alert('Error adding product: ' + result.message);
                }
            } catch (error) {
                alert('Error adding product');
                console.error(error);
            }
        });
        
        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            const productId = productData.productId;
            delete productData.productId; // Remove the ID from the data to update
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Product updated successfully!');
                    closeModal('editProductModal');
                    await loadProducts();
                    await loadDashboardData(); // Refresh dashboard stats
                } else {
                    alert('Error updating product: ' + result.message);
                }
            } catch (error) {
                alert('Error updating product');
                console.error(error);
            }
        });
        
        document.getElementById('addOutletForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const outletData = Object.fromEntries(formData.entries());
            
            // Normalize phone number: remove spaces and dashes
            if (outletData.phone) {
                outletData.phone = outletData.phone.replace(/[\s-]/g, '');
            }
            
            // Include coordinates only if both lat and lng are provided
            const latProvided = outletData.lat !== undefined && outletData.lat !== '';
            const lngProvided = outletData.lng !== undefined && outletData.lng !== '';
            if (latProvided && lngProvided) {
            outletData.coordinates = {
                lat: parseFloat(outletData.lat),
                lng: parseFloat(outletData.lng)
            };
            }
            delete outletData.lat;
            delete outletData.lng;
            
            try {
                const response = await fetch(`${API_BASE_URL}/outlets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(outletData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Outlet added successfully!');
                    closeModal('addOutletModal');
                    e.target.reset();
                    loadOutlets();
                } else {
                    alert('Error adding outlet: ' + result.message);
                }
            } catch (error) {
                alert('Error adding outlet');
                console.error(error);
            }
        });

        // Open Edit Outlet modal and prefill
        async function editOutlet(outletId) {
            try {
                const res = await fetch(`${API_BASE_URL}/outlets/${outletId}`);
                const data = await res.json();
                if (!data.success || !data.data) {
                    alert('Failed to load outlet details');
                    return;
                }
                const outlet = data.data;
                document.getElementById('editOutletId').value = outlet._id;
                document.getElementById('editOutletName').value = outlet.name || '';
                document.getElementById('editOutletAddress').value = outlet.address || '';
                document.getElementById('editOutletPhone').value = outlet.phone || '';
                document.getElementById('editOutletEmail').value = outlet.email || '';
                document.getElementById('editOutletLat').value = outlet.coordinates && outlet.coordinates.lat != null ? outlet.coordinates.lat : '';
                document.getElementById('editOutletLng').value = outlet.coordinates && outlet.coordinates.lng != null ? outlet.coordinates.lng : '';
                document.getElementById('editOutletModal').style.display = 'block';
            } catch (err) {
                console.error('Error fetching outlet:', err);
                alert('Error loading outlet');
            }
        }

        // Submit Edit Outlet form
        document.getElementById('editOutletForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const outletData = Object.fromEntries(formData.entries());
            const outletId = outletData.outletId;
            delete outletData.outletId;

            // Normalize phone
            if (outletData.phone) {
                outletData.phone = outletData.phone.replace(/[\s-]/g, '');
            }

            const latProvided = outletData.lat !== undefined && outletData.lat !== '';
            const lngProvided = outletData.lng !== undefined && outletData.lng !== '';
            if (latProvided && lngProvided) {
                outletData.coordinates = {
                    lat: parseFloat(outletData.lat),
                    lng: parseFloat(outletData.lng)
                };
            }
            delete outletData.lat;
            delete outletData.lng;

            try {
                const res = await fetch(`${API_BASE_URL}/outlets/${outletId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(outletData)
                });
                const result = await res.json();
                if (result.success) {
                    showNotification('Outlet updated successfully', 'success');
                    closeModal('editOutletModal');
                    await loadOutlets();
                } else {
                    alert('Error updating outlet: ' + (result.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error updating outlet:', err);
                alert('Network error updating outlet');
            }
        });

        // Delete outlet
        async function deleteOutlet(outletId) {
            if (!confirm('Are you sure you want to delete this outlet?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/outlets/${outletId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    showNotification('Outlet deleted', 'success');
                    await loadOutlets();
                } else {
                    alert('Error deleting outlet: ' + (result.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error deleting outlet:', err);
                alert('Network error deleting outlet');
            }
        }
        
        // Utility functions
        async function refreshData() {
            console.log('refreshData called');
            
            // Check if we're on the dashboard section
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection && dashboardSection.style.display !== 'none') {
                console.log('Refreshing dashboard data...');
                // Refresh dashboard statistics and data
                await loadDashboardData();
                // Show success message
                showNotification('Dashboard data refreshed successfully!', 'success');
            } else {
                // For other sections, refresh the active section
            const activeSection = document.querySelector('.nav-link.active');
            if (activeSection) {
                console.log('Active section found:', activeSection.textContent);
                // Get the onclick attribute to determine the section name
                const onclickAttr = activeSection.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/showSection\('([^']+)'\)/);
                    if (match) {
                        const sectionName = match[1];
                        console.log('Loading section:', sectionName);
                            await loadSectionData(sectionName);
                            showNotification('Section data refreshed successfully!', 'success');
                    }
                }
            } else {
                console.log('No active section found');
                }
            }
        }


        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
        // Payment management functions
        async function loadPayments() {
            try {
                const response = await fetch(`${API_BASE_URL}/payments`);
                const data = await response.json();
                
                const paymentsTable = document.getElementById('payments-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    paymentsTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(payment => `
                                    <tr data-payment-id="${payment._id}" data-status="${payment.status}" data-method="${payment.paymentMethod}">
                                        <td>${payment.transactionId}</td>
                                        <td>${payment.customer?.name || 'N/A'}</td>
                                        <td>KSH ${payment.amount.toLocaleString()}</td>
                                        <td>${getPaymentMethodName(payment.paymentMethod)}</td>
                                        <td>
                                            <span class="status-badge status-${payment.status}">${getStatusName(payment.status)}</span>
                                        </td>
                                        <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewPaymentDetails('${payment._id}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="updatePaymentStatus('${payment._id}')" title="Update Status">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    paymentsTable.innerHTML = '<p>No payments found</p>';
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('payments-table').innerHTML = '<p>Error loading payments</p>';
            }
        }

        function filterPayments() {
            const searchTerm = document.getElementById('payment-search').value.toLowerCase();
            const statusFilter = document.getElementById('payment-status-filter').value;
            const methodFilter = document.getElementById('payment-method-filter').value;
            
            const rows = document.querySelectorAll('#payments-table tbody tr');
            
            rows.forEach(row => {
                const transactionId = row.cells[0].textContent.toLowerCase();
                const customer = row.cells[1].textContent.toLowerCase();
                const method = row.cells[3].textContent.toLowerCase();
                const status = row.cells[4].textContent.toLowerCase();
                
                const matchesSearch = transactionId.includes(searchTerm) || customer.includes(searchTerm);
                const matchesStatus = !statusFilter || status.includes(statusFilter);
                const matchesMethod = !methodFilter || method.includes(methodFilter);
                
                row.style.display = matchesSearch && matchesStatus && matchesMethod ? '' : 'none';
            });
        }

        function viewPaymentDetails(paymentId) {
            // This would open a modal with detailed payment information
            alert(`Viewing payment details for: ${paymentId}`);
        }

        function updatePaymentStatus(paymentId) {
            const newStatus = prompt('Enter new status (pending/processing/completed/failed/cancelled):');
            if (newStatus && ['pending', 'processing', 'completed', 'failed', 'cancelled'].includes(newStatus)) {
                // This would update the payment status via API
                alert(`Payment status updated to: ${newStatus}`);
            }
        }

        function getPaymentMethodName(method) {
            const methods = {
                'mpesa': 'M-Pesa',
                'airtel_money': 'Airtel Money',
                'equitel': 'Equitel',
                'cash': 'Cash',
                'card': 'Card',
                'bank_transfer': 'Bank Transfer'
            };
            return methods[method] || method;
        }

        function getStatusName(status) {
            const statuses = {
                'pending': 'Pending',
                'processing': 'Processing',
                'completed': 'Completed',
                'failed': 'Failed',
                'cancelled': 'Cancelled'
            };
            return statuses[status] || status;
        }

        // Sales Management Data
        async function loadSalesManagementData() {
            try {
                console.log('Loading sales management data...');
                
                // Fetch salespeople data from API
                const salespeopleResponse = await fetch('/api/sales');
                const salespeopleResult = await salespeopleResponse.json();
                
                if (!salespeopleResult.success) {
                    throw new Error(salespeopleResult.message || 'Failed to fetch salespeople data');
                }

                // Fetch sales statistics from API
                const statsResponse = await fetch('/api/sales/stats/overview');
                const statsResult = await statsResponse.json();
                
                if (!statsResult.success) {
                    throw new Error(statsResult.message || 'Failed to fetch sales statistics');
                }

                const salespeopleData = salespeopleResult.data;
                window.__salespeopleCache = salespeopleData;
                const statsData = statsResult.data;

                // Update stats
                document.getElementById('total-salespeople').textContent = statsData.totalSalespeople || 0;
                document.getElementById('total-sales').textContent = `KSH ${(statsData.totalCurrentSales || 0).toLocaleString()}`;
                document.getElementById('sales-growth').textContent = 'N/A'; // Not implemented in API yet
                document.getElementById('target-achievement').textContent = statsData.totalSalesTarget > 0 ? 
                    `${Math.round((statsData.totalCurrentSales / statsData.totalSalesTarget) * 100)}%` : '0%';

                // Load salespeople table
                const salespeopleTable = document.getElementById('salespeople-table');
                if (salespeopleData.length === 0) {
                    salespeopleTable.innerHTML = '<p>No salespeople found. Add your first salesperson!</p>';
                } else {
                    salespeopleTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Territory</th>
                                    <th>Target</th>
                                    <th>Current Sales</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${salespeopleData.map(person => `
                                    <tr>
                                        <td>${person.name}</td>
                                        <td>${person.phone}</td>
                                        <td>${person.email}</td>
                                        <td>${person.territory}</td>
                                        <td>KSH ${(person.salesTarget || 0).toLocaleString()}</td>
                                        <td>KSH ${(person.currentSales || 0).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="showEditSalespersonModal('${person._id}', {name: '${person.name}', phone: '${person.phone}', email: '${person.email}', territory: '${person.territory}', target: ${person.salesTarget || 0}})">Edit</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSalesperson('${person._id}', '${person.name}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Load sales leaderboard
                const salesLeaderboard = document.getElementById('sales-leaderboard');
                const topPerformers = statsData.topPerformers || [];
                if (topPerformers.length === 0) {
                    salesLeaderboard.innerHTML = '<p>No performance data available</p>';
                } else {
                    salesLeaderboard.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Salesperson</th>
                                    <th>Territory</th>
                                    <th>Target</th>
                                    <th>Current Sales</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topPerformers.map(person => `
                                    <tr>
                                        <td>${person.name}</td>
                                        <td>${person.territory}</td>
                                        <td>KSH ${(person.salesTarget || 0).toLocaleString()}</td>
                                        <td>KSH ${(person.performance?.totalSales || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

            } catch (error) {
                console.error('Error loading sales management data:', error);
                document.getElementById('sales-management-section').innerHTML = '<p>Error loading sales management data: ' + error.message + '</p>';
            }
        }

        // Filter salespeople by search input
        function filterSalespeople() {
            const input = document.getElementById('sales-search');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            const data = Array.isArray(window.__salespeopleCache) ? window.__salespeopleCache : [];
            const filtered = term
                ? data.filter(p => [p.name, p.phone, p.email, p.territory]
                    .filter(Boolean)
                    .some(v => String(v).toLowerCase().includes(term)))
                : data;

            const salespeopleTable = document.getElementById('salespeople-table');
            if (!filtered.length) {
                salespeopleTable.innerHTML = '<p>No matching salespeople</p>';
                return;
            }

            salespeopleTable.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Territory</th>
                            <th>Target</th>
                            <th>Current Sales</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(person => `
                            <tr>
                                <td>${person.name}</td>
                                <td>${person.phone}</td>
                                <td>${person.email}</td>
                                <td>${person.territory}</td>
                                <td>KSH ${(person.salesTarget || 0).toLocaleString()}</td>
                                <td>KSH ${(person.currentSales || 0).toLocaleString()}</td>
                                <td>
                                    <button class=\"btn btn-warning btn-sm\" onclick=\"showEditSalespersonModal('${person._id}', {name: '${person.name}', phone: '${person.phone}', email: '${person.email}', territory: '${person.territory}', target: ${person.salesTarget || 0}})\">Edit</button>
                                    <button class=\"btn btn-danger btn-sm\" onclick=\"deleteSalesperson('${person._id}', '${person.name}')\">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }



        // Driver Management Data
        async function loadDriverManagementData() {
            try {
                console.log('Loading driver management data...');
                
                // Fetch drivers data from API
                const driversResponse = await fetch('/api/drivers');
                const driversResult = await driversResponse.json();
                
                if (!driversResult.success) {
                    throw new Error(driversResult.message || 'Failed to fetch drivers data');
                }

                // Fetch driver statistics from API
                const statsResponse = await fetch('/api/drivers/stats/overview');
                const statsResult = await statsResponse.json();
                
                if (!statsResult.success) {
                    throw new Error(statsResult.message || 'Failed to fetch driver statistics');
                }

                const driversData = driversResult.data;
                const statsData = statsResult.data;

                // Update stats
                document.getElementById('total-drivers').textContent = statsData.totalDrivers || 0;
                document.getElementById('total-deliveries').textContent = statsData.totalDrivers > 0 ? 
                    (statsData.totalDrivers * 5).toLocaleString() : '0'; // Placeholder calculation
                document.getElementById('completed-deliveries').textContent = statsData.totalDrivers > 0 ? 
                    Math.round(statsData.totalDrivers * 5 * 0.85).toLocaleString() : '0'; // Placeholder calculation
                document.getElementById('avg-delivery-time').textContent = statsData.averageRating ? 
                    `${Math.round(30 - statsData.averageRating * 2)} minutes` : 'N/A';

                // Load drivers table
                const driversTable = document.getElementById('drivers-table');
                if (driversData.length === 0) {
                    driversTable.innerHTML = '<p>No drivers found. Add your first driver!</p>';
                } else {
                    driversTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>License</th>
                                    <th>Vehicle</th>
                                    <th>Territory</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${driversData.map(driver => `
                                    <tr>
                                        <td>${driver.name}</td>
                                        <td>${driver.phone}</td>
                                        <td>${driver.email}</td>
                                        <td>${driver.license}</td>
                                        <td>${driver.vehicle}</td>
                                        <td>${driver.territory}</td>
                                        <td><span class="btn btn-${driver.status === 'active' ? 'success' : 'danger'}">${driver.status}</span></td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="showEditDriverModal('${driver._id}', {name: '${driver.name}', phone: '${driver.phone}', email: '${driver.email}', license: '${driver.license}', vehicle: '${driver.vehicle}', territory: '${driver.territory}', status: '${driver.status}'})">Edit</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteDriver('${driver._id}', '${driver.name}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Load active deliveries (placeholder for now)
                const activeDeliveries = document.getElementById('active-deliveries');
                activeDeliveries.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Destination</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px;">
                                    <p>Delivery tracking will be implemented in the next phase</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('Error loading driver management data:', error);
                document.getElementById('driver-management-section').innerHTML = '<p>Error loading driver management data: ' + error.message + '</p>';
            }
        }



        // Warehouse Management Data
        async function loadWarehouseManagementData() {
            try {
                console.log('Loading warehouse management data...');
                
                // Fetch real products data from API
                const productsResponse = await fetch('/api/products');
                const productsResult = await productsResponse.json();
                
                if (!productsResult.success) {
                    throw new Error(productsResult.message || 'Failed to fetch products data');
                }

                // Fetch real outlets data from API
                const outletsResponse = await fetch('/api/outlets');
                const outletsResult = await outletsResponse.json();
                
                if (!outletsResult.success) {
                    throw new Error(outletsResult.message || 'Failed to fetch outlets data');
                }

                // Fetch stock movements data from API
                const movementsResponse = await fetch('/api/stock-movements');
                const movementsResult = await movementsResponse.json();
                
                if (!movementsResult.success) {
                    throw new Error(movementsResult.message || 'Failed to fetch stock movements data');
                }

                // Fetch stock movements statistics from API
                const statsResponse = await fetch('/api/stock-movements/stats/overview');
                const statsResult = await statsResponse.json();
                
                if (!statsResult.success) {
                    throw new Error(statsResult.message || 'Failed to fetch stock movements statistics');
                }

                const productsData = productsResult.data;
                const outletsData = outletsResult.data;
                const movementsData = movementsResult.data;
                const statsData = statsResult.data;

                // Calculate real inventory metrics
                const totalProducts = productsData.length;
                const totalInventoryValue = productsData.reduce((total, product) => {
                    return total + (product.price * product.stockLevel);
                }, 0);
                
                const lowStockItems = productsData.filter(product => 
                    product.stockLevel <= product.lowStockThreshold
                ).length;

                // Update stats with real data
                document.getElementById('total-inventory').textContent = totalProducts;
                document.getElementById('low-stock-items').textContent = lowStockItems;
                document.getElementById('inventory-value').textContent = `KSH ${totalInventoryValue.toLocaleString()}`;
                document.getElementById('stock-movements').textContent = statsData.totalMovements || 0;

                // Load real inventory table
                const inventoryTable = document.getElementById('inventory-table');
                if (productsData.length === 0) {
                    inventoryTable.innerHTML = '<p>No products found in inventory</p>';
                } else {
                    inventoryTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Stock Level</th>
                                    <th>Low Stock Alert</th>
                                    <th>Price (KSH)</th>
                                    <th>Stock Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsData.map(product => `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${product.brand}</td>
                                        <td>${product.category}</td>
                                        <td>${product.stockLevel}</td>
                                        <td>${product.lowStockThreshold}</td>
                                        <td>${product.price.toLocaleString()}</td>
                                        <td><span class="btn btn-${product.stockStatus === 'in_stock' ? 'success' : product.stockLevel <= product.lowStockThreshold ? 'danger' : 'warning'}">${product.stockStatus}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Build productId -> name map for display
                const productNameById = new Map();
                (productsData || []).forEach(p => {
                    if (p && (p._id || p.id)) {
                        productNameById.set(p._id || p.id, p.name || '');
                    }
                });

                // Load stock movements table
                const stockMovementsTable = document.getElementById('stock-movements-table');
                if (movementsData.length === 0) {
                    stockMovementsTable.innerHTML = '<p>No stock movements found. Add your first movement!</p>';
                } else {
                    stockMovementsTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Date</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th id="movement-actions-col" style="display:none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${movementsData.map(movement => `
                                    <tr data-movement-id="${movement._id || ''}">
                                        <td><span class="btn btn-${movement.type === 'inbound' ? 'success' : 'warning'}">${movement.type}</span></td>
                                        <td>${productNameById.get(movement.product) || movement.productName || movement.product}</td>
                                        <td>${movement.quantity}</td>
                                        <td>${new Date(movement.date).toLocaleDateString()}</td>
                                        <td>${movement.reason}</td>
                                        <td><span class="btn btn-${movement.status === 'completed' ? 'success' : 'warning'}">${movement.status}</span></td>
                                        <td class="movement-actions" style="display:none;">
                                            <button class="btn btn-warning btn-sm" onclick="editMovement('${movement._id}')">Edit</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteMovement('${movement._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Reveal actions for admins only
                const role = localStorage.getItem('role') || 'admin';
                if (role === 'admin') {
                    const actionsCol = document.getElementById('movement-actions-col');
                    if (actionsCol) actionsCol.style.display = '';
                    document.querySelectorAll('.movement-actions').forEach(td => td.style.display = '');
                }

                // Populate outlet selector
                await populateOutletSelector();

            } catch (error) {
                console.error('Error loading warehouse management data:', error);
                document.getElementById('warehouse-management-section').innerHTML = '<p>Error loading warehouse management data: ' + error.message + '</p>';
            }
        }

        // Populate outlet selector with real data from database
        async function populateOutletSelector() {
            try {
                const outletSelect = document.getElementById('outlet-selector');
                const outletsResponse = await fetch('/api/outlets');
                const outletsResult = await outletsResponse.json();
                
                if (outletsResult.success) {
                    // Clear existing options except the first one
                    outletSelect.innerHTML = '<option value="">Select Outlet</option>';
                    
                    // Add real outlets from database
                    outletsResult.data.forEach(outlet => {
                        const option = document.createElement('option');
                        option.value = outlet._id;
                        option.textContent = outlet.name;
                        outletSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating outlet selector:', error);
            }
        }

        // Function to filter inventory table with debouncing
        let searchTimeout;
        function filterInventory() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
                const table = document.getElementById('inventory-table');
                const rows = table.querySelectorAll('tr');
                
                let visibleCount = 0;
                let totalCount = rows.length - 1; // Exclude header row
                
                // Skip header row
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.querySelectorAll('td');
                    let shouldShow = false;
                    
                    // Check if any cell contains the search term
                    cells.forEach(cell => {
                        if (cell.textContent.toLowerCase().includes(searchTerm)) {
                            shouldShow = true;
                        }
                    });
                    
                    // Show/hide row based on search
                    row.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) visibleCount++;
                }
                
                // Update search results counter
                updateSearchResultsCounter(visibleCount, totalCount, searchTerm);
                
                // Show "no results" message if needed
                showNoResultsMessage(visibleCount, searchTerm);
            }, 300); // 300ms delay for better performance
        }

        // Function to clear inventory search
        function clearInventorySearch() {
            document.getElementById('inventory-search').value = '';
            filterInventory(); // This will show all rows
        }

        // Function to update search results counter
        function updateSearchResultsCounter(visibleCount, totalCount, searchTerm) {
            const searchBox = document.querySelector('.search-box');
            let counter = searchBox.querySelector('.search-counter');
            
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'search-counter';
                searchBox.appendChild(counter);
            }
            
            if (searchTerm) {
                counter.textContent = `Showing ${visibleCount} of ${totalCount} items`;
                counter.style.display = 'block';
            } else {
                counter.style.display = 'none';
            }
        }

        // Function to show no results message
        function showNoResultsMessage(visibleCount, searchTerm) {
            const table = document.getElementById('inventory-table');
            let noResultsRow = table.querySelector('.no-results-row');
            
            if (visibleCount === 0 && searchTerm) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666; font-style: italic;">
                            <i class="fas fa-search" style="font-size: 2em; color: #ddd; margin-bottom: 10px; display: block;"></i>
                            No inventory items found matching "${searchTerm}"
                            <br><small>Try adjusting your search terms</small>
                        </td>
                    `;
                    table.appendChild(noResultsRow);
                }
            } else if (noResultsRow) {
                noResultsRow.remove();
            }
        }

        // Add keyboard shortcuts for search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('inventory-search');
            if (searchInput) {
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearInventorySearch();
                        this.blur(); // Remove focus from input
                    }
                });
            }
        });

        // Load outlet-specific inventory
        async function loadOutletInventory() {
            const selectedOutletId = document.getElementById('outlet-selector').value;
            if (!selectedOutletId) {
                document.getElementById('outlet-inventory-table').innerHTML = '<div class="loading">Select an outlet to view inventory...</div>';
                return;
            }

            try {
                // Get selected outlet name
                const selectedOutletName = document.getElementById('outlet-selector').options[document.getElementById('outlet-selector').selectedIndex].text;
                
                // Fetch products data to calculate outlet-specific inventory
                const productsResponse = await fetch('/api/products');
                const productsResult = await productsResponse.json();
                
                if (!productsResult.success) {
                    throw new Error('Failed to fetch products data');
                }

                // Calculate outlet-specific inventory distribution
                const outletInventory = calculateOutletInventory(productsResult.data, selectedOutletId, selectedOutletName);
                
                // Display outlet-specific inventory
                document.getElementById('outlet-inventory-table').innerHTML = outletInventory;

            } catch (error) {
                console.error('Error loading outlet inventory:', error);
                document.getElementById('outlet-inventory-table').innerHTML = '<p>Error loading outlet inventory: ' + error.message + '</p>';
            }
        }

        // Calculate outlet-specific inventory distribution
        function calculateOutletInventory(products, outletId, outletName) {
            // Business logic for inventory distribution across outlets
            const outletDistribution = {
                '68b171d2a29965f9dd24c873': { // Kagio Branch
                    name: 'Kagio Branch',
                    location: 'Kirinyaga',
                    distribution: 0.25, // 25% of inventory
                    focus: ['Abai Springs', 'Sprinkle'] // All brands
                },
                '68af22f5f30164a808b155d0': { // Karen Branch
                    name: 'Karen Branch', 
                    location: 'Nairobi',
                    distribution: 0.30, // 30% of inventory
                    focus: ['Abai Springs'] // Premium brand focus
                },
                '68b17bfb40b3411cece8dcf5': { // Kiambu Road Branch
                    name: 'Kiambu Road Branch',
                    location: 'Nairobi',
                    distribution: 0.25, // 25% of inventory
                    focus: ['Sprinkle', 'Abai Springs'] // Mixed brand focus
                },
                '68b1817840b3411cece8dd17': { // Northern Bypass Branch
                    name: 'Northern Bypass Branch',
                    location: 'Nairobi',
                    distribution: 0.20, // 20% of inventory
                    focus: ['Sprinkle'] // Budget brand focus
                }
            };

            const outlet = outletDistribution[outletId];
            if (!outlet) {
                return '<p>Outlet not found</p>';
            }

            // Calculate outlet-specific metrics
            let totalProducts = 0;
            let totalValue = 0;
            let lowStockItems = 0;
            let outletProducts = [];

            products.forEach(product => {
                // Calculate outlet-specific stock level
                const outletStock = Math.floor(product.stockLevel * outlet.distribution);
                const outletValue = outletStock * product.price;
                
                totalProducts += outletStock;
                totalValue += outletValue;
                
                if (outletStock <= product.lowStockThreshold) {
                    lowStockItems++;
                }

                outletProducts.push({
                    ...product,
                    outletStock: outletStock,
                    outletValue: outletValue
                });
            });

            // Filter products based on outlet focus
            const focusedProducts = outletProducts.filter(product => 
                outlet.focus.includes(product.brand)
            );

            return `
                <div class="outlet-inventory-header">
                    <h3>ðŸ“ ${outlet.name} - ${outlet.location}</h3>
                    <div class="outlet-stats-grid">
                        <div class="outlet-stat-card">
                            <div class="stat-number">${totalProducts}</div>
                            <div class="stat-label" style="color: white; font-weight: bold;">Total Products</div>
                        </div>
                        <div class="outlet-stat-card">
                            <div class="stat-number">KSH ${totalValue.toLocaleString()}</div>
                            <div class="stat-label" style="color: white; font-weight: bold;">Inventory Value</div>
                        </div>
                        <div class="outlet-stat-card">
                            <div class="stat-number">${lowStockItems}</div>
                            <div class="stat-label" style="color: white; font-weight: bold;">Low Stock Items</div>
                        </div>
                        <div class="outlet-stat-card">
                            <div class="stat-number">${focusedProducts.length}</div>
                            <div class="stat-label" style="color: white; font-weight: bold;">Focus Products</div>
                        </div>
                    </div>
                </div>
                
                <div class="outlet-inventory-table">
                    <h4>ðŸ“¦ Inventory at ${outlet.name}</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Brand</th>
                                <th>Category</th>
                                <th>Outlet Stock</th>
                                <th>Low Stock Alert</th>
                                <th>Price (KSH)</th>
                                <th>Outlet Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${focusedProducts.map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${product.brand}</td>
                                    <td>${product.category}</td>
                                    <td>${product.outletStock}</td>
                                    <td>${product.lowStockThreshold}</td>
                                    <td>${product.price.toLocaleString()}</td>
                                    <td>KSH ${product.outletValue.toLocaleString()}</td>
                                    <td><span class="btn btn-${product.outletStock <= product.lowStockThreshold ? 'danger' : 'success'}">${product.outletStock <= product.lowStockThreshold ? 'Low Stock' : 'In Stock'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="outlet-notes">
                    <p><strong>ðŸ“‹ Notes:</strong></p>
                    <ul>
                        <li>This outlet focuses on: <strong>${outlet.focus.join(', ')}</strong> brands</li>
                        <li>Inventory distribution: <strong>${(outlet.distribution * 100)}%</strong> of total company stock</li>
                        <li>Location: <strong>${outlet.location}</strong></li>
                        <li>Last updated: <strong>${new Date().toLocaleDateString()}</strong></li>
                    </ul>
                </div>
            `;
        }

        // Staff Management Data
        async function loadStaffManagementData() {
            try {
                console.log('Loading staff management data...');
                
                // Fetch staff data from API
                const staffResponse = await fetch('/api/staff');
                const staffResult = await staffResponse.json();
                
                if (!staffResult.success) {
                    throw new Error(staffResult.message || 'Failed to fetch staff data');
                }

                // Fetch staff statistics from API
                const statsResponse = await fetch('/api/staff/stats/overview');
                const statsResult = await statsResponse.json();
                
                if (!statsResult.success) {
                    throw new Error(statsResult.message || 'Failed to fetch staff statistics');
                }

                const staffData = staffResult.data;
                const statsData = statsResult.data;

                // Update stats
                document.getElementById('total-staff').textContent = statsData.totalStaff || 0;
                document.getElementById('active-staff').textContent = statsData.activeStaff || 0;
                document.getElementById('roles-count').textContent = statsData.staffByRole?.length || 0;
                document.getElementById('recent-logins').textContent = 'N/A'; // Not implemented in API yet

                // Load staff table
                const staffTable = document.getElementById('staff-table');
                if (staffData.length === 0) {
                    staffTable.innerHTML = '<p>No staff members found. Add your first staff member!</p>';
                } else {
                    staffTable.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${staffData.map(user => `
                                    <tr>
                                        <td>${user.name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.phone}</td>
                                        <td>${user.role}</td>
                                        <td>${user.department || 'Not assigned'}</td>
                                        <td><span class="btn btn-${user.status === 'active' ? 'success' : 'danger'}">${user.status}</span></td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="showEditStaffModal('${user._id}', {name: '${user.name}', email: '${user.email}', phone: '${user.phone}', role: '${user.role}', department: '${user.department || ''}', status: '${user.status}'})">Edit</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteStaff('${user._id}', '${user.name}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Load role permissions (simplified for now)
                const rolePermissions = document.getElementById('role-permissions');
                const roles = statsData.staffByRole || [];
                if (roles.length === 0) {
                    rolePermissions.innerHTML = '<p>No role data available</p>';
                } else {
                    rolePermissions.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Role</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${roles.map(role => `
                                    <tr>
                                        <td>${role._id}</td>
                                        <td>${role.count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

            } catch (error) {
                console.error('Error loading staff management data:', error);
                document.getElementById('user-management-section').innerHTML = '<p>Error loading staff management data: ' + error.message + '</p>';
            }
        }

        // Smart Stock Alerts Functions
        async function loadSmartStockAlerts() {
            try {
                // Load alert statistics
                const statsResponse = await fetch(`${API_BASE_URL}/stock-alerts/statistics`);
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    const stats = statsData.data || {};
                    
                    document.getElementById('total-alerts').textContent = stats.totalAlerts || 0;
                    document.getElementById('enabled-alerts').textContent = stats.enabledAlerts || 0;
                    document.getElementById('alerts-needing-attention').textContent = stats.alertsNeedingAttention || 0;
                    document.getElementById('monitoring-status').textContent = stats.monitoringActive ? 'Active' : 'Inactive';
                    
                    // Update monitoring status color
                    const statusElement = document.getElementById('monitoring-status');
                    if (stats.monitoringActive) {
                        statusElement.style.color = '#28a745';
                    } else {
                        statusElement.style.color = '#dc3545';
                    }
                } else {
                    console.error('Failed to load alert statistics:', statsData.message);
                }
                
                await loadActiveAlertsTable();
                
            } catch (error) {
                console.error('Error loading stock alerts:', error);
                // Set default values
                document.getElementById('total-alerts').textContent = '0';
                document.getElementById('enabled-alerts').textContent = '0';
                document.getElementById('alerts-needing-attention').textContent = '0';
                document.getElementById('monitoring-status').textContent = 'Inactive';
            }
        }

        async function loadActiveAlertsTable() {
            try {
                const alertsTable = document.getElementById('stock-alerts-table');
                alertsTable.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Outlet</th>
                                    <th>Current Stock</th>
                                    <th>Predicted Run-out</th>
                                    <th>Alert Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">
                                        <i class="fas fa-info-circle"></i>
                                        Smart Stock Alerts system is ready! 
                                        <br>Create alerts when customers place orders.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading active alerts table:', error);
                document.getElementById('stock-alerts-table').innerHTML = '<p>Error loading alerts table</p>';
            }
        }

        async function startMonitoring() {
            try {
                const response = await fetch(`${API_BASE_URL}/stock-alerts/monitoring/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Monitoring started successfully!');
                    await loadSmartStockAlerts(); // Refresh stats
                } else {
                    alert('Error starting monitoring: ' + data.message);
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
                alert('Error starting monitoring. Please try again.');
            }
        }

        async function stopMonitoring() {
            try {
                const response = await fetch(`${API_BASE_URL}/stock-alerts/monitoring/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Monitoring stopped successfully!');
                    await loadSmartStockAlerts(); // Refresh stats
                } else {
                    alert('Error stopping monitoring: ' + data.message);
                }
            } catch (error) {
                console.error('Error stopping monitoring:', error);
                alert('Error stopping monitoring. Please try again.');
            }
        }

        async function refreshAlertStats() {
            await loadSmartStockAlerts();
            alert('Alert statistics refreshed!');
        }

        function showTestAlertModal() {
            const modal = document.getElementById('alert-config-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Add fade-in animation
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
                
                // Load customers, products, and outlets for the form
                loadCustomersForAlert();
                loadProductsForAlert();
                loadOutletsForAlert();
            }
        }

        function viewAlertHistory() {
            alert('Alert history feature - This would show the history of all sent alerts.');
        }

        // Alert Modal Functions
        function closeAlertModal() {
            const modal = document.getElementById('alert-config-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        function toggleAlertOptions() {
            const alertType = document.getElementById('alert-type').value;
            const productSelection = document.getElementById('product-selection');
            
            if (alertType === 'stock_low' || alertType === 'stock_critical') {
                productSelection.style.display = 'block';
                document.getElementById('alert-product').required = true;
            } else {
                productSelection.style.display = 'none';
                document.getElementById('alert-product').required = false;
            }
        }

        // Load customers for alert targeting
        async function loadCustomersForAlert() {
            try {
                const response = await fetch('/api/orders');
                const orders = await response.json();
                
                // Extract unique customers from orders
                const customers = new Map();
                orders.forEach(order => {
                    if (order.customerName && order.customerEmail) {
                        customers.set(order.customerEmail, {
                            name: order.customerName,
                            email: order.customerEmail,
                            phone: order.customerPhone
                        });
                    }
                });

                const customerSelect = document.getElementById('alert-customer');
                customerSelect.innerHTML = '<option value="">Select Customer</option><option value="all">All Customers</option>';
                
                customers.forEach((customer, email) => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = `${customer.name} (${email})`;
                    customerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Load products for alert targeting
        async function loadProductsForAlert() {
            try {
                const response = await fetch('/api/products');
                const products = await response.json();
                
                const productSelect = document.getElementById('alert-product');
                productSelect.innerHTML = '<option value="">Select Product</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product._id;
                    option.textContent = `${product.name} (${product.brand}) - ${product.category}`;
                    productSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load outlets for alert targeting
        async function loadOutletsForAlert() {
            try {
                const response = await fetch('/api/outlets');
                const outlets = await response.json();
                
                const outletSelect = document.getElementById('alert-outlet');
                outletSelect.innerHTML = '<option value="">Select Outlet</option><option value="all">All Outlets</option>';
                
                outlets.forEach(outlet => {
                    const option = document.createElement('option');
                    option.value = outlet._id;
                    option.textContent = outlet.name;
                    outletSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading outlets:', error);
            }
        }

        // Send test alert
        function sendTestAlert() {
            const formData = getAlertFormData();
            if (!validateAlertForm(formData)) return;

            // Show test alert preview
            const preview = `
                Test Alert Preview:
                Type: ${formData.type}
                Customer: ${formData.customer}
                Message: ${formData.message}
                Delivery: ${formData.deliveryMethods.join(', ')}
                Priority: ${formData.priority}
            `;
            
            alert(preview);
        }

        // Send actual alert
        async function sendAlert() {
            const formData = getAlertFormData();
            if (!validateAlertForm(formData)) return;

            try {
                const response = await fetch('/api/alerts/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Alert sent successfully!');
                    closeAlertModal();
                } else {
                    throw new Error('Failed to send alert');
                }
            } catch (error) {
                console.error('Error sending alert:', error);
                alert('Error sending alert. Please try again.');
            }
        }

        // Get form data
        function getAlertFormData() {
            const deliveryMethods = [];
            if (document.getElementById('delivery-email').checked) deliveryMethods.push('email');
            if (document.getElementById('delivery-sms').checked) deliveryMethods.push('sms');
            if (document.getElementById('delivery-push').checked) deliveryMethods.push('push');

            return {
                type: document.getElementById('alert-type').value,
                customer: document.getElementById('alert-customer').value,
                product: document.getElementById('alert-product').value,
                outlet: document.getElementById('alert-outlet').value,
                message: document.getElementById('alert-message').value,
                deliveryMethods: deliveryMethods,
                priority: document.getElementById('alert-priority').value,
                schedule: document.querySelector('input[name="schedule"]:checked').value,
                scheduleTime: document.getElementById('alert-schedule-time').value
            };
        }

        // Validate form
        function validateAlertForm(formData) {
            if (!formData.type) {
                alert('Please select an alert type.');
                return false;
            }
            if (!formData.customer) {
                alert('Please select a target customer.');
                return false;
            }
            if (!formData.outlet) {
                alert('Please select an outlet.');
                return false;
            }
            if (!formData.message.trim()) {
                alert('Please enter an alert message.');
                return false;
            }
            if (formData.deliveryMethods.length === 0) {
                alert('Please select at least one delivery method.');
                return false;
            }
            return true;
        }

        // Schedule change handler
        document.addEventListener('DOMContentLoaded', function() {
            const scheduleRadios = document.querySelectorAll('input[name="schedule"]');
            const scheduleDatetime = document.getElementById('schedule-datetime');
            
            scheduleRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'scheduled') {
                        scheduleDatetime.style.display = 'block';
                    } else {
                        scheduleDatetime.style.display = 'none';
                    }
                });
            });

            // Load outlets when modal opens
            const alertModal = document.getElementById('alert-config-modal');
            if (alertModal) {
                alertModal.addEventListener('click', function(e) {
                    if (e.target === alertModal) {
                        closeAlertModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && alertModal && alertModal.style.display === 'flex') {
                    closeAlertModal();
                }
            });
        });

        // Test function for debugging
        function testFunction() {
            alert('JavaScript is working!');
        }

        // Modal Functions for Sales Management
        function showAddSalespersonModal() {
            document.getElementById('addSalespersonModal').style.display = 'block';
            // Reset form
            document.getElementById('addSalespersonForm').reset();
            // Populate territories from Outlets
            const territorySelect = document.getElementById('salespersonTerritory');
            populateSalesTerritories(territorySelect, '');
        }

        function closeAddSalespersonModal() {
            document.getElementById('addSalespersonModal').style.display = 'none';
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const addSalespersonForm = document.getElementById('addSalespersonForm');
            if (addSalespersonForm) {
                addSalespersonForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddSalesperson();
                });
            }
        });

        // Populate Sales Territories from Outlets API
        async function populateSalesTerritories(selectElement, selectedValue) {
            if (!selectElement) return;
            try {
                selectElement.innerHTML = '<option value="">Loading...</option>';
                const res = await fetch(`${API_BASE_URL}/outlets`, { cache: 'no-store' });
                const result = await res.json();
                const outlets = result && result.success ? result.data : [];
                const optionsHtml = ['<option value="">Select Territory</option>']
                    .concat(outlets.map(o => `<option value="${(o.name || '').replace(/"/g, '&quot;')}">${o.name}</option>`))
                    .join('');
                selectElement.innerHTML = optionsHtml;
                if (selectedValue) {
                    selectElement.value = selectedValue;
                }
            } catch (err) {
                console.error('Failed to load outlets for territories', err);
                selectElement.innerHTML = '<option value="">Select Territory</option>';
            }
        }

        async function handleAddSalesperson() {
            try {
                const formData = new FormData(document.getElementById('addSalespersonForm'));
                const salespersonData = {
                    name: formData.get('name'),
                    phone: formData.get('phone') ? formData.get('phone').replace(/[\s-]/g, '') : '',
                    email: formData.get('email'),
                    territory: formData.get('territory'),
                    salesTarget: formData.get('target') ? parseInt(formData.get('target')) : 0
                };

                // Validate required fields
                if (!salespersonData.name || !salespersonData.phone || !salespersonData.email || !salespersonData.territory) {
                    alert('Name, Phone, Email, and Territory are required fields!');
                    return;
                }

                // Send POST request to API
                const response = await fetch('/api/sales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(salespersonData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Salesperson ${salespersonData.name} added successfully!\n\nDetails:\nName: ${salespersonData.name}\nPhone: ${salespersonData.phone}\nEmail: ${salespersonData.email}\nTerritory: ${salespersonData.territory}\nTarget: KSH ${salespersonData.salesTarget.toLocaleString()}`);

                    // Close modal
                    closeAddSalespersonModal();

                    // Refresh the sales team data
                    await loadSalesManagementData();
                } else {
                    alert('Error: ' + (result.message || 'Failed to create salesperson'));
                }

            } catch (error) {
                console.error('Error adding salesperson:', error);
                alert('Error adding salesperson. Please try again.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addSalespersonModal');
            if (event.target === modal) {
                closeAddSalespersonModal();
            }
            const editModal = document.getElementById('editSalespersonModal');
            if (event.target === editModal) {
                closeEditSalespersonModal();
            }
            const addStaffModal = document.getElementById('addStaffModal');
            if (event.target === addStaffModal) {
                closeAddStaffModal();
            }
            const editStaffModal = document.getElementById('editStaffModal');
            if (event.target === editStaffModal) {
                closeEditStaffModal();
            }
            const addStockMovementModal = document.getElementById('addStockMovementModal');
            if (event.target === addStockMovementModal) {
                closeAddStockMovementModal();
            }
            const addDriverModal = document.getElementById('addDriverModal');
            if (event.target === addDriverModal) {
                closeAddDriverModal();
            }
            const editDriverModal = document.getElementById('editDriverModal');
            if (event.target === editDriverModal) {
                closeEditDriverModal();
            }
        }

        // Edit Salesperson Functions
        function showEditSalespersonModal(salespersonId, salespersonData) {
            // Populate form with existing data
            document.getElementById('editSalespersonId').value = salespersonId;
            document.getElementById('editSalespersonName').value = salespersonData.name || '';
            document.getElementById('editSalespersonPhone').value = salespersonData.phone || '';
            document.getElementById('editSalespersonEmail').value = salespersonData.email || '';
            // Populate territories from Outlets then set current value
            const editSelect = document.getElementById('editSalespersonTerritory');
            populateSalesTerritories(editSelect, salespersonData.territory || '');
            document.getElementById('editSalespersonTarget').value = salespersonData.target || '';
            
            // Show modal
            document.getElementById('editSalespersonModal').style.display = 'block';
        }

        function closeEditSalespersonModal() {
            document.getElementById('editSalespersonModal').style.display = 'none';
        }

        // Handle edit form submission
        document.addEventListener('DOMContentLoaded', function() {
            const editSalespersonForm = document.getElementById('editSalespersonForm');
            if (editSalespersonForm) {
                editSalespersonForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleEditSalesperson();
                });
            }
        });

        async function handleEditSalesperson() {
            try {
                const formData = new FormData(document.getElementById('editSalespersonForm'));
                const salespersonData = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    territory: formData.get('territory'),
                    salesTarget: formData.get('target') ? parseInt(formData.get('target')) : 0
                };

                const salespersonId = formData.get('id');

                // Validate required fields
                if (!salespersonData.name || !salespersonData.phone || !salespersonData.email || !salespersonData.territory) {
                    alert('Name, Phone, Email, and Territory are required fields!');
                    return;
                }

                // Send PUT request to API
                const response = await fetch(`/api/sales/${salespersonId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(salespersonData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Salesperson ${salespersonData.name} updated successfully!\n\nUpdated Details:\nName: ${salespersonData.name}\nPhone: ${salespersonData.phone}\nEmail: ${salespersonData.email}\nTerritory: ${salespersonData.territory}\nTarget: KSH ${salespersonData.salesTarget.toLocaleString()}`);

                    // Close modal
                    closeEditSalespersonModal();

                    // Refresh the sales team data
                    await loadSalesManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error updating salesperson:', error);
                alert('Error updating salesperson. Please try again.');
            }
        }

        // Delete Salesperson Function
        async function deleteSalesperson(salespersonId, salespersonName) {
            if (confirm(`Are you sure you want to delete ${salespersonName}?\n\nThis action cannot be undone.`)) {
                try {
                    // Send DELETE request to API
                    const response = await fetch(`/api/sales/${salespersonId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`Salesperson ${salespersonName} has been deleted successfully.`);
                        
                        // Refresh the sales team data
                        await loadSalesManagementData();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error deleting salesperson:', error);
                    alert('Error deleting salesperson. Please try again.');
                }
            }
        }

        // Staff Management Modal Functions
        function showAddStaffModal() {
            document.getElementById('addStaffModal').style.display = 'block';
            // Reset form
            document.getElementById('addStaffForm').reset();
        }

        function closeAddStaffModal() {
            document.getElementById('addStaffModal').style.display = 'none';
        }

        function showEditStaffModal(staffId, staffData) {
            // Populate form with existing data
            document.getElementById('editStaffId').value = staffId;
            document.getElementById('editStaffName').value = staffData.name || '';
            document.getElementById('editStaffEmail').value = staffData.email || '';
            document.getElementById('editStaffPhone').value = staffData.phone || '';
            document.getElementById('editStaffRole').value = staffData.role || '';
            document.getElementById('editStaffDepartment').value = staffData.department || '';
            document.getElementById('editStaffStatus').value = staffData.status || 'active';
            
            // Show modal
            document.getElementById('editStaffModal').style.display = 'block';
        }

        function closeEditStaffModal() {
            document.getElementById('editStaffModal').style.display = 'none';
        }

        // Handle staff form submissions
        document.addEventListener('DOMContentLoaded', function() {
            const addStaffForm = document.getElementById('addStaffForm');
            if (addStaffForm) {
                addStaffForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddStaff();
                });
            }

            const editStaffForm = document.getElementById('editStaffForm');
            if (editStaffForm) {
                editStaffForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleEditStaff();
                });
            }
        });

        async function handleAddStaff() {
            try {
                const formData = new FormData(document.getElementById('addStaffForm'));
                const staffData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    role: formData.get('role'),
                    department: formData.get('department'),
                    status: formData.get('status')
                };

                // Validate required fields
                if (!staffData.name || !staffData.email || !staffData.phone || !staffData.role) {
                    alert('Name, Email, Phone, and Role are required fields!');
                    return;
                }

                // Send POST request to API
                const response = await fetch('/api/staff', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(staffData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Staff Member ${staffData.name} added successfully!\n\nDetails:\nName: ${staffData.name}\nEmail: ${staffData.email}\nPhone: ${staffData.phone}\nRole: ${staffData.role}\nDepartment: ${staffData.department || 'Not assigned'}\nStatus: ${staffData.status}`);

                    // Close modal
                    closeAddStaffModal();

                    // Refresh the staff data
                    await loadStaffManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error adding staff member:', error);
                alert('Error adding staff member. Please try again.');
            }
        }

        async function handleEditStaff() {
            try {
                const formData = new FormData(document.getElementById('editStaffForm'));
                const staffData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    role: formData.get('role'),
                    department: formData.get('department'),
                    status: formData.get('status')
                };

                const staffId = formData.get('id');

                // Validate required fields
                if (!staffData.name || !staffData.email || !staffData.phone || !staffData.role) {
                    alert('Name, Email, Phone, and Role are required fields!');
                    return;
                }

                // Send PUT request to API
                const response = await fetch(`/api/staff/${staffId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(staffData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Staff Member ${staffData.name} updated successfully!\n\nUpdated Details:\nName: ${staffData.name}\nEmail: ${staffData.email}\nPhone: ${staffData.phone}\nRole: ${staffData.role}\nDepartment: ${staffData.department || 'Not assigned'}\nStatus: ${staffData.status}`);

                    // Close modal
                    closeEditStaffModal();

                    // Refresh the staff data
                    await loadStaffManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error updating staff member:', error);
                alert('Error updating staff member. Please try again.');
            }
        }

        // Delete Staff Function
        async function deleteStaff(staffId, staffName) {
            if (confirm(`Are you sure you want to delete ${staffName}?\n\nThis action cannot be undone.`)) {
                try {
                    // Send DELETE request to API
                    const response = await fetch(`/api/staff/${staffId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`Staff Member ${staffName} has been deleted successfully.`);
                        
                        // Refresh the staff data
                        await loadStaffManagementData();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error deleting staff member:', error);
                    alert('Error deleting staff member. Please try again.');
                }
            }
        }

        // Stock Movement Modal Functions
        async function showAddStockMovementModal() {
            document.getElementById('addStockMovementModal').style.display = 'block';
            // Reset form and set today's date
            document.getElementById('addStockMovementForm').reset();
            document.getElementById('movementDate').value = new Date().toISOString().split('T')[0];
            
            // Populate product dropdown with real data
            await populateProductDropdown();
            // Populate unified source/destination
            await populateLocations();
            // Adjust defaults/requirements based on movement type
            applyMovementTypeDefaults();
        }

        // Populate product dropdown with real data from database
        async function populateProductDropdown() {
            try {
                const productSelect = document.getElementById('productName');
                const productsResponse = await fetch('/api/products', { cache: 'no-store' });
                const productsResult = await productsResponse.json();
                
                if (productsResult.success) {
                    // Clear existing options except the first one
                    productSelect.innerHTML = '<option value="">Select Product</option>';
                    
                    // Add real products from database
                    productsResult.data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product._id || product.name; // Prefer ID, fallback to name
                        option.textContent = `${product.name} (${product.brand}) - KSH ${product.price}`;
                        productSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating product dropdown:', error);
            }
        }

        async function populateLocations() {
            const source = document.getElementById('sourceLocation');
            const dest = document.getElementById('destinationLocation');
            if (!source || !dest) return;
            source.innerHTML = '<option value="">Select Source</option>';
            dest.innerHTML = '<option value="">Select Destination</option>';
            // External options
            const supplier = new Option('Supplier (external)', 'external:supplier');
            const customer = new Option('Customer (external)', 'external:customer');
            const warehouse = new Option('Warehouse (central)', 'internal:warehouse');
            source.appendChild(supplier.cloneNode(true));
            source.appendChild(customer.cloneNode(true));
            source.appendChild(warehouse.cloneNode(true));
            dest.appendChild(supplier.cloneNode(true));
            dest.appendChild(customer.cloneNode(true));
            dest.appendChild(warehouse.cloneNode(true));
            try {
                const res = await fetch('/api/outlets', { cache: 'no-store' });
                const json = await res.json();
                const outlets = json && json.success ? json.data : [];
                outlets.forEach(o => {
                    const opt = new Option(o.name, o._id || o.id);
                    source.appendChild(opt.cloneNode(true));
                    dest.appendChild(opt.cloneNode(true));
                });
            } catch (e) {
                console.error('Failed to load outlets', e);
            }
        }

        function applyMovementTypeDefaults() {
            const typeEl = document.getElementById('movementType');
            const type = typeEl.value;
            const source = document.getElementById('sourceLocation');
            const dest = document.getElementById('destinationLocation');
            // Clear selection
            source.value = '';
            dest.value = '';
            if (type === 'inbound') {
                source.value = 'external:supplier';
                dest.value = 'internal:warehouse';
            } else if (type === 'outbound') {
                source.value = 'internal:warehouse';
                dest.value = 'external:customer';
            }
        }

        function closeAddStockMovementModal() {
            document.getElementById('addStockMovementModal').style.display = 'none';
        }

        // Handle stock movement form submission
        document.addEventListener('DOMContentLoaded', function() {
            const addStockMovementForm = document.getElementById('addStockMovementForm');
            if (addStockMovementForm) {
                addStockMovementForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddStockMovement();
                });
            }
        });

        async function handleAddStockMovement() {
            try {
                const formData = new FormData(document.getElementById('addStockMovementForm'));
                const movementData = {
                    type: formData.get('type'),
                    product: formData.get('product'),
                    quantity: parseInt(formData.get('quantity')),
                    date: formData.get('date'),
                    reason: formData.get('reason'),
                    notes: formData.get('notes'),
                    authorizedBy: '68b63dfd0b0e8f240cac97f5' // Use the first staff member as default for now
                };

                // Unified locations
                movementData.fromLocation = formData.get('fromLocation') || formData.get('fromOutlet') || '';
                movementData.toLocation = formData.get('toLocation') || formData.get('toOutlet') || '';
                if (movementData.type === 'transfer') {
                    if (!movementData.fromLocation || !movementData.toLocation || movementData.fromLocation === movementData.toLocation) {
                        alert('For a transfer, select different Source and Destination.');
                        return;
                    }
                }

                // Validate required fields
                if (!movementData.type || !movementData.product || !movementData.quantity || !movementData.date || !movementData.reason) {
                    alert('Movement Type, Product, Quantity, Date, and Reason are required fields!');
                    return;
                }

                // Send POST request to API
                const response = await fetch('/api/stock-movements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Role': localStorage.getItem('role') || 'admin'
                    },
                    body: JSON.stringify(movementData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Stock Movement added successfully!\n\nDetails:\nType: ${movementData.type}\nProduct: ${movementData.product}\nQuantity: ${movementData.quantity}\nDate: ${movementData.date}\nReason: ${movementData.reason}\nNotes: ${movementData.notes || 'None'}`);

                    // Close modal
                    closeAddStockMovementModal();

                    // Refresh the warehouse data
                    await loadWarehouseManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error adding stock movement:', error);
                alert('Error adding stock movement. Please try again.');
            }
        }

        // Admin-only edit/delete handlers
        async function deleteMovement(movementId) {
            const role = localStorage.getItem('role') || 'admin';
            if (role !== 'admin') { alert('Only admins can delete movements.'); return; }
            if (!confirm('Delete this stock movement?')) return;
            try {
                const res = await fetch(`/api/stock-movements/${movementId}`, { method: 'DELETE', headers: { 'X-Role': role } });
                const json = await res.json();
                if (json.success) {
                    showNotification('Stock movement deleted', 'success');
                    await loadWarehouseManagementData();
                } else {
                    alert('Error deleting movement: ' + (json.message || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Network error deleting movement');
            }
        }

        async function editMovement(movementId) {
            const role = localStorage.getItem('role') || 'admin';
            if (role !== 'admin') { alert('Only admins can edit movements.'); return; }
            try {
                // Load movement details
                const res = await fetch(`/api/stock-movements/${movementId}`);
                const json = await res.json();
                if (!json.success) { alert('Failed to load movement'); return; }
                const m = json.data;

                // Populate edit form
                document.getElementById('editMovementId').value = m._id;
                // Products and locations
                await populateEditProductDropdown(m.product);
                await populateEditLocations(m.fromLocation, m.toLocation);

                document.getElementById('editMovementType').value = m.type;
                document.getElementById('editMovementQuantity').value = m.quantity;
                document.getElementById('editMovementDate').value = new Date(m.date).toISOString().split('T')[0];
                document.getElementById('editMovementReason').value = m.reason || '';

                document.getElementById('editStockMovementModal').style.display = 'block';
            } catch (e) {
                console.error(e);
                alert('Error loading movement');
            }
        }

        function closeEditStockMovementModal() {
            document.getElementById('editStockMovementModal').style.display = 'none';
        }

        async function populateEditProductDropdown(selected) {
            try {
                const sel = document.getElementById('editProductName');
                sel.innerHTML = '<option value="">Select Product</option>';
                const res = await fetch('/api/products', { cache: 'no-store' });
                const json = await res.json();
                if (json.success) {
                    json.data.forEach(p => {
                        const opt = new Option(`${p.name} (${p.brand}) - KSH ${p.price}`, p._id || p.name);
                        sel.appendChild(opt);
                    });
                }
                if (selected) sel.value = selected;
            } catch (e) { console.error(e); }
        }

        async function populateEditLocations(fromVal, toVal) {
            const source = document.getElementById('editSourceLocation');
            const dest = document.getElementById('editDestinationLocation');
            source.innerHTML = '<option value="">Select Source</option>';
            dest.innerHTML = '<option value="">Select Destination</option>';
            const supplier = new Option('Supplier (external)', 'external:supplier');
            const customer = new Option('Customer (external)', 'external:customer');
            const warehouse = new Option('Warehouse (central)', 'internal:warehouse');
            [supplier, customer, warehouse].forEach(opt => { source.appendChild(opt.cloneNode(true)); dest.appendChild(opt.cloneNode(true));});
            try {
                const res = await fetch('/api/outlets', { cache: 'no-store' });
                const json = await res.json();
                if (json.success) {
                    json.data.forEach(o => {
                        const opt = new Option(o.name, o._id || o.id);
                        source.appendChild(opt.cloneNode(true));
                        dest.appendChild(opt.cloneNode(true));
                    });
                }
            } catch (e) { console.error(e); }
            if (fromVal) source.value = fromVal;
            if (toVal) dest.value = toVal;
        }

        document.getElementById('editStockMovementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = localStorage.getItem('role') || 'admin';
            if (role !== 'admin') { alert('Only admins can edit movements.'); return; }
            const form = new FormData(e.target);
            const id = form.get('id');
            const payload = {
                type: form.get('type'),
                product: form.get('product'),
                quantity: parseInt(form.get('quantity')),
                date: form.get('date'),
                reason: form.get('reason'),
                fromLocation: form.get('fromLocation'),
                toLocation: form.get('toLocation')
            };
            try {
                const res = await fetch(`/api/stock-movements/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Role': role }, body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.success) {
                    showNotification('Stock movement updated', 'success');
                    closeEditStockMovementModal();
                    await loadWarehouseManagementData();
                } else {
                    alert('Error updating movement: ' + (json.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('Network error updating movement');
            }
        });

        // Driver Management Modal Functions
        function showAddDriverModal() {
            document.getElementById('addDriverModal').style.display = 'block';
            // Reset form
            document.getElementById('addDriverForm').reset();
            // Populate delivery territories from Outlets
            const territorySelect = document.getElementById('driverTerritory');
            populateSalesTerritories(territorySelect, '');
        }

        function closeAddDriverModal() {
            document.getElementById('addDriverModal').style.display = 'none';
        }

        function showEditDriverModal(driverId, driverData) {
            // Populate form with existing data
            document.getElementById('editDriverId').value = driverId;
            document.getElementById('editDriverName').value = driverData.name || '';
            document.getElementById('editDriverPhone').value = driverData.phone || '';
            document.getElementById('editDriverEmail').value = driverData.email || '';
            document.getElementById('editDriverLicense').value = driverData.license || '';
            document.getElementById('editDriverVehicle').value = driverData.vehicle || '';
            // Populate delivery territories from Outlets then set current value
            const editSelect = document.getElementById('editDriverTerritory');
            populateSalesTerritories(editSelect, driverData.territory || '');
            document.getElementById('editDriverStatus').value = driverData.status || 'active';
            
            // Show modal
            document.getElementById('editDriverModal').style.display = 'block';
        }

        function closeEditDriverModal() {
            document.getElementById('editDriverModal').style.display = 'none';
        }

        // Handle driver form submissions
        document.addEventListener('DOMContentLoaded', function() {
            const addDriverForm = document.getElementById('addDriverForm');
            if (addDriverForm) {
                addDriverForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddDriver();
                });
            }

            const editDriverForm = document.getElementById('editDriverForm');
            if (editDriverForm) {
                editDriverForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleEditDriver();
                });
            }
        });

        async function handleAddDriver() {
            try {
                const formData = new FormData(document.getElementById('addDriverForm'));
                const driverData = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    license: formData.get('license'),
                    vehicle: formData.get('vehicle'),
                    territory: formData.get('territory'),
                    status: formData.get('status')
                };

                // Validate required fields
                if (!driverData.name || !driverData.phone || !driverData.email || !driverData.license || !driverData.vehicle || !driverData.territory) {
                    alert('Name, Phone, Email, License Number, Vehicle, and Territory are required fields!');
                    return;
                }

                // Send POST request to API
                const response = await fetch('/api/drivers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(driverData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Driver ${driverData.name} added successfully!\n\nDetails:\nName: ${driverData.name}\nPhone: ${driverData.phone}\nEmail: ${driverData.email}\nLicense: ${driverData.license}\nVehicle: ${driverData.vehicle}\nTerritory: ${driverData.territory}\nStatus: ${driverData.status}`);

                    // Close modal
                    closeAddDriverModal();

                    // Refresh the driver data
                    await loadDriverManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error adding driver:', error);
                alert('Error adding driver. Please try again.');
            }
        }

        async function handleEditDriver() {
            try {
                const formData = new FormData(document.getElementById('editDriverForm'));
                const driverData = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    license: formData.get('license'),
                    vehicle: formData.get('vehicle'),
                    territory: formData.get('territory'),
                    status: formData.get('status')
                };

                const driverId = formData.get('id');

                // Validate required fields
                if (!driverData.name || !driverData.phone || !driverData.email || !driverData.license || !driverData.vehicle || !driverData.territory) {
                    alert('Name, Phone, Email, License Number, Vehicle, and Territory are required fields!');
                    return;
                }

                // Send PUT request to API
                const response = await fetch(`/api/drivers/${driverId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(driverData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Driver ${driverData.name} updated successfully!\n\nUpdated Details:\nName: ${driverData.name}\nPhone: ${driverData.phone}\nEmail: ${driverData.email}\nLicense: ${driverData.license}\nVehicle: ${driverData.vehicle}\nTerritory: ${driverData.territory}\nStatus: ${driverData.status}`);

                    // Close modal
                    closeEditDriverModal();

                    // Refresh the driver data
                    await loadDriverManagementData();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Error updating driver:', error);
                alert('Error updating driver. Please try again.');
            }
        }

        // Delete Driver Function
        async function deleteDriver(driverId, driverName) {
            if (confirm(`Are you sure you want to delete ${driverName}?\n\nThis action cannot be undone.`)) {
                try {
                    // Send DELETE request to API
                    const response = await fetch(`/api/drivers/${driverId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`Driver ${driverName} has been deleted successfully.`);
                        
                        // Refresh the driver data
                        await loadDriverManagementData();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error deleting driver:', error);
                    alert('Error deleting driver. Please try again.');
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded successfully');
            loadDashboardData();
            
            // Add refresh button functionality
            const refreshButtons = document.querySelectorAll('.btn-refresh');
            refreshButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const section = this.closest('.section-content');
                    if (section.id === 'warehouse-management-section') {
                        loadWarehouseManagementData();
                    } else if (section.id === 'user-management-section') {
                        loadStaffManagementData();
                    } else if (section.id === 'sales-management-section') {
                        loadSalesManagementData();
                    } else if (section.id === 'driver-management-section') {
                        loadDriverManagementData();
                    }
                });
            });
        });
    </script>

    <!-- Alert Configuration Modal -->
    <div id="alert-config-modal" class="alert-modal">
        <div class="alert-modal-content">
            <div class="alert-modal-header">
                <h2><i class="fas fa-bell"></i> Configure Alert</h2>
                <button class="alert-modal-close" onclick="closeAlertModal()" aria-label="Close alert modal">&times;</button>
            </div>
            
            <div class="alert-modal-body">
                <form id="alert-config-form">
                    <!-- Alert Type Selection -->
                    <div class="form-group">
                        <label for="alert-type"><i class="fas fa-cog"></i> Alert Type</label>
                        <select id="alert-type" class="form-control" required onchange="toggleAlertOptions()">
                            <option value="">Select Alert Type</option>
                            <option value="stock_low">Low Stock Alert</option>
                            <option value="stock_critical">Critical Stock Alert</option>
                            <option value="custom">Custom Alert</option>
                            <option value="promotional">Promotional Alert</option>
                            <option value="delivery">Delivery Update</option>
                        </select>
                    </div>

                    <!-- Customer Selection -->
                    <div class="form-group">
                        <label for="alert-customer"><i class="fas fa-user"></i> Target Customer</label>
                        <select id="alert-customer" class="form-control" required>
                            <option value="">Select Customer</option>
                            <option value="all">All Customers</option>
                            <!-- Customers will be loaded dynamically -->
                        </select>
                    </div>

                    <!-- Product Selection (for stock alerts) -->
                    <div class="form-group" id="product-selection" style="display: none;">
                        <label for="alert-product"><i class="fas fa-box"></i> Product</label>
                        <select id="alert-product" class="form-control">
                            <option value="">Select Product</option>
                            <!-- Products will be loaded dynamically -->
                        </select>
                    </div>

                    <!-- Outlet Selection -->
                    <div class="form-group">
                        <label for="alert-outlet"><i class="fas fa-store"></i> Outlet</label>
                        <select id="alert-outlet" class="form-control" required>
                            <option value="">Select Outlet</option>
                            <option value="all">All Outlets</option>
                            <!-- Outlets will be loaded dynamically -->
                        </select>
                    </div>

                    <!-- Alert Message -->
                    <div class="form-group">
                        <label for="alert-message"><i class="fas fa-comment"></i> Alert Message</label>
                        <textarea id="alert-message" class="form-control" rows="4" placeholder="Enter your alert message..." required></textarea>
                        <small class="form-text">You can use variables like {customer_name}, {product_name}, {outlet_name}</small>
                    </div>

                    <!-- Delivery Methods -->
                    <div class="form-group">
                        <label><i class="fas fa-paper-plane"></i> Delivery Methods</label>
                        <div class="delivery-methods">
                            <label class="checkbox-label">
                                <input type="checkbox" id="delivery-email" checked>
                                <span class="checkmark"></span>
                                <i class="fas fa-envelope"></i> Email
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="delivery-sms">
                                <span class="checkmark"></span>
                                <i class="fas fa-sms"></i> SMS
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="delivery-push">
                                <span class="checkmark"></span>
                                <i class="fas fa-mobile-alt"></i> Push Notification
                            </label>
                        </div>
                    </div>

                    <!-- Priority Level -->
                    <div class="form-group">
                        <label for="alert-priority"><i class="fas fa-exclamation-triangle"></i> Priority Level</label>
                        <select id="alert-priority" class="form-control">
                            <option value="low">Low Priority</option>
                            <option value="medium" selected>Medium Priority</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>

                    <!-- Schedule Options -->
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Schedule</label>
                        <div class="schedule-options">
                            <label class="radio-label">
                                <input type="radio" name="schedule" value="immediate" checked>
                                <span class="radiomark"></span>
                                Send Immediately
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="schedule" value="scheduled">
                                <span class="radiomark"></span>
                                Schedule for Later
                            </label>
                        </div>
                        <div id="schedule-datetime" style="display: none;">
                            <input type="datetime-local" id="alert-schedule-time" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="alert-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAlertModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="sendTestAlert()">
                    <i class="fas fa-paper-plane"></i> Send Test Alert
                </button>
                <button type="button" class="btn btn-success" onclick="sendAlert()">
                    <i class="fas fa-bell"></i> Send Alert
                </button>
            </div>
        </div>
    </div>

</body>
</html> 